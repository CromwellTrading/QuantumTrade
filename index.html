<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Signal Trader Pro</title>
    <style>
        :root {
            --primary: #00f0ff;
            --primary-dark: #00a8ff;
            --primary-light: #6effff;
            --secondary: #ff2d95;
            --accent: #00ff9d;
            --vip: #ffcc00;
            --profit: #00ff9d;
            --loss: #ff0033;
            --warning: #ffcc00;
            --dark: #0a0a1f;
            --darker: #050510;
            --panel: #13132e;
            --panel-light: #1c1c3e;
            --light: #e0e1ff;
            --text: #e0e1ff;
            --text-secondary: #a0a4d8;
            --border: #2a2a5a;
            --success-glow: 0 0 15px rgba(0, 255, 157, 0.8);
            --error-glow: 0 0 15px rgba(255, 0, 51, 0.8);
            --primary-glow: 0 0 15px rgba(0, 240, 255, 0.8);
            --vip-glow: 0 0 15px rgba(255, 204, 0, 0.8);
            --pulse-animation: pulse 2s infinite;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Rajdhani', 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, var(--darker) 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 240, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 45, 149, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 255, 157, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(19, 19, 46, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .user-id-display {
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
            font-weight: 700;
            letter-spacing: 1px;
            animation: textGlow 3s infinite alternate;
        }

        @keyframes textGlow {
            0% {
                text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
            }
            100% {
                text-shadow: 0 0 20px rgba(0, 240, 255, 0.8), 0 0 30px rgba(255, 45, 149, 0.6);
            }
        }

        .header-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(28, 28, 62, 0.8);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        .header-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .header-btn:hover::before {
            left: 100%;
        }

        .header-btn:hover {
            background: var(--panel-light);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
            transform: translateY(-2px);
        }

        .header-btn.active {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
            box-shadow: var(--primary-glow);
        }

        .header-btn.vip {
            border-color: var(--vip);
            color: var(--vip);
        }

        .header-btn.vip.active {
            background: var(--vip);
            color: var(--dark);
            box-shadow: var(--vip-glow);
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 20px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
        }

        .panel {
            background: linear-gradient(145deg, var(--panel) 0%, var(--panel-light) 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.05) 0%, transparent 50%, rgba(255, 45, 149, 0.05) 100%);
            z-index: 0;
        }

        .panel > * {
            position: relative;
            z-index: 1;
        }

        .panel:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            transform: translateY(-5px);
        }

        .admin-panel h3, .signals-panel h3, .stats-panel h3, .referrals-panel h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 600;
            font-size: 0.95rem;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 10, 31, 0.7);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--primary-glow);
            background: rgba(10, 10, 31, 0.9);
        }

        button {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            color: var(--dark);
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .signal-card {
            background: linear-gradient(145deg, var(--panel-light) 0%, var(--panel) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .signal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.1), transparent);
            transform: translateX(-100%);
        }

        .signal-card.new::before {
            animation: shine 1.5s ease-out;
        }

        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-left-color: var(--accent);
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .asset {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .direction {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .direction::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
        }

        .direction:hover::before {
            animation: shine 1.5s;
        }

        .direction.up {
            background: rgba(0, 255, 157, 0.15);
            color: var(--profit);
            border: 1px solid var(--profit);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
        }

        .direction.down {
            background: rgba(255, 0, 51, 0.15);
            color: var(--loss);
            border: 1px solid var(--loss);
            box-shadow: 0 0 10px rgba(255, 0, 51, 0.3);
        }

        .arrow {
            font-size: 1.4rem;
            animation: bounce 1s infinite alternate;
        }

        .arrow.up {
            color: var(--profit);
            text-shadow: 0 0 10px var(--profit);
        }

        .arrow.down {
            color: var(--loss);
            text-shadow: 0 0 10px var(--loss);
        }

        @keyframes bounce {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(-5px);
            }
        }

        .signal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .signal-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .status-pending {
            background: rgba(255, 204, 0, 0.15);
            color: var(--warning);
            border: 1px solid var(--warning);
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }

        .status-profit {
            background: rgba(0, 255, 157, 0.15);
            color: var(--profit);
            border: 1px solid var(--profit);
            box-shadow: var(--success-glow);
        }

        .status-loss {
            background: rgba(255, 0, 51, 0.15);
            color: var(--loss);
            border: 1px solid var(--loss);
            box-shadow: var(--error-glow);
        }

        .time-remaining {
            text-align: center;
            padding: 12px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 700;
            color: var(--primary);
            border: 1px solid var(--border);
            animation: pulse 2s infinite;
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 15px rgba(0, 240, 255, 0.8);
            }
            100% {
                box-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
            }
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
            color: var(--primary);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0);
            }
        }

        .ready-btn {
            background: linear-gradient(90deg, var(--accent), #00cc7a);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            animation: pulse 2s infinite;
        }

        .ready-btn.ready {
            background: linear-gradient(90deg, var(--secondary), #cc00b3);
            animation: none;
        }

        .vip-btn {
            background: linear-gradient(90deg, var(--vip), #ff9900);
            margin-bottom: 20px;
        }

        .session-info {
            background: rgba(0, 240, 255, 0.1);
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .session-active {
            background: rgba(0, 255, 157, 0.1);
            border-color: var(--profit);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.3);
        }

        .stats-container, .users-container {
            display: none;
            margin-top: 30px;
        }

        .stats-container.active, .users-container.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, var(--panel-light) 0%, var(--panel) 100%);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.05) 0%, transparent 50%, rgba(255, 45, 149, 0.05) 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 15px 0;
            text-shadow: 0 0 10px currentColor;
        }

        .stat-profit {
            color: var(--profit);
        }

        .stat-loss {
            color: var(--loss);
        }

        .stat-total {
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .chart-container {
            background: linear-gradient(145deg, var(--panel-light) 0%, var(--panel) 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .time-filters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .time-filter {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .time-filter.active {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
            box-shadow: var(--primary-glow);
        }

        .operations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .operations-table th, .operations-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .operations-table th {
            color: var(--primary);
            font-weight: 700;
            background: var(--panel-light);
            text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }

        .operations-table tr {
            transition: all 0.3s ease;
        }

        .operations-table tr:hover {
            background: rgba(0, 240, 255, 0.05);
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .admin-btn {
            padding: 10px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            flex: 1;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-profit {
            background: var(--profit);
            color: var(--dark);
        }

        .btn-loss {
            background: var(--loss);
            color: white;
        }

        .btn-pending {
            background: var(--warning);
            color: var(--dark);
        }

        .btn-notify {
            background: linear-gradient(90deg, var(--warning), #ff9900);
            color: var(--dark);
        }

        .btn-vip {
            background: linear-gradient(90deg, var(--vip), #ff9900);
            color: var(--dark);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 28px;
            background: var(--profit);
            color: var(--dark);
            border-radius: 8px;
            font-weight: 700;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .signal-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(145deg, var(--panel) 0%, var(--panel-light) 100%);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 35px;
            text-align: center;
            z-index: 2000;
            transition: transform 0.5s ease;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .signal-alert.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .signal-alert .asset {
            font-size: 2.5rem;
            margin-bottom: 25px;
            color: var(--primary);
            text-shadow: 0 0 15px rgba(0, 240, 255, 0.7);
        }

        .signal-alert .direction {
            justify-content: center;
            margin-bottom: 25px;
            font-size: 1.4rem;
            padding: 12px 25px;
        }

        .signal-alert .arrow {
            font-size: 2.5rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 16, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(145deg, var(--panel) 0%, var(--panel-light) 100%);
            border-radius: 15px;
            padding: 35px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .vip-badge {
            display: inline-block;
            background: linear-gradient(90deg, var(--vip), #ff9900);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            margin-left: 10px;
            font-size: 0.8rem;
            text-shadow: none;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }

        .user-status {
            margin-bottom: 20px;
        }

        /* Resultado de operaci√≥n */
        .operation-result {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            z-index: 2;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .result-profit {
            background: var(--profit);
            color: var(--dark);
            animation: pulse 2s infinite;
        }

        .result-loss {
            background: var(--loss);
            color: white;
            animation: pulse 2s infinite;
        }

        /* Efectos de part√≠culas */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            animation: floatParticle 15s infinite linear;
        }

        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px);
                opacity: 0;
            }
        }

        /* Estilos para la tabla de usuarios */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th, .users-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .users-table th {
            background: var(--panel-light);
            color: var(--primary);
            font-weight: 700;
        }

        .users-table tr:hover {
            background: rgba(0, 240, 255, 0.05);
        }

        .user-actions {
            display: flex;
            gap: 5px;
        }

        .user-action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .vip-expiry {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .days-left {
            font-weight: 700;
            margin-left: 5px;
        }

        .days-left.warning {
            color: var(--warning);
        }

        .days-left.danger {
            color: var(--loss);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 240, 255, 0.1);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected {
            background: var(--profit);
        }

        .status-disconnected {
            background: var(--loss);
        }

        /* Estilos para gesti√≥n de usuarios VIP */
        .user-management-section {
            background: rgba(0, 240, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-btn {
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .user-search-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(19, 19, 46, 0.8);
            border: 1px solid var(--border);
        }

        .user-found, .user-not-found {
            text-align: center;
        }

        .user-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .user-details {
            text-align: left;
        }

        .user-status.vip {
            color: var(--vip);
            font-weight: bold;
        }

        .user-status.regular {
            color: var(--text-secondary);
        }

        .vip-time-remaining {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 204, 0, 0.1);
            border-radius: 5px;
            border: 1px solid var(--vip);
        }

        .days-left {
            color: var(--vip);
            font-weight: bold;
        }

        .error {
            color: var(--loss);
            text-align: center;
        }

        .user-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .signal-details {
                grid-template-columns: 1fr;
            }
            
            .signal-alert {
                width: 90%;
                padding: 25px;
            }
            
            .header-controls {
                flex-direction: column;
                width: 100%;
                margin-top: 15px;
            }
            
            .header-btn {
                width: 100%;
            }
            
            .user-actions {
                flex-direction: column;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .user-id-display {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 10px;
                text-align: center;
            }
        }

        /* Debug panel */
        #debugInfo {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 10px;
            z-index: 10000;
            font-size: 12px;
            border-radius: 5px;
            max-width: 300px;
            word-break: break-all;
            border: 2px solid white;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <header>
            <div>
                <!-- Display del ID del usuario -->
                <div id="userIdDisplay" class="user-id-display">ID: Cargando...</div>
                <h1>QUANTUM SIGNAL TRADER PRO</h1>
                <p class="header-subtitle">Sistema de Se√±ales para Opciones Binarias</p>
            </div>
            <div class="header-controls">
                <button class="header-btn active" id="showSignals"><i class="fas fa-broadcast-tower"></i> Se√±ales</button>
                <button class="header-btn" id="showStats"><i class="fas fa-chart-bar"></i> Estad√≠sticas</button>
                <button class="header-btn" id="showUsers" style="display: none;"><i class="fas fa-users"></i> Usuarios</button>
                <button class="header-btn vip" id="vipAccess"><i class="fas fa-crown"></i> VIP</button>
                <button class="header-btn" id="adminBtn" style="display: none;"><i class="fas fa-user-shield"></i> Admin</button>
            </div>
        </header>
        
        <div class="connection-status" id="connectionStatus">
            <div class="status-dot status-connected" id="statusDot"></div>
            <span id="statusText">Conectado al servidor</span>
        </div>
        
        <div class="session-info" id="sessionInfo">
            <i class="fas fa-clock"></i> Sesi√≥n inactiva - Inicia una sesi√≥n para comenzar
        </div>
        
        <div class="grid">
            <div class="panel admin-panel" id="adminPanel" style="display: none;">
                <h3><i class="fas fa-user-shield"></i> Panel de Control Administrativo</h3>
                
                <!-- Gesti√≥n de Usuarios VIP -->
                <div class="user-management-section">
                    <h4><i class="fas fa-users-cog"></i> Gesti√≥n de Usuarios VIP</h4>
                    
                    <div class="form-group">
                        <label for="userSearchInput"><i class="fas fa-search"></i> Buscar Usuario por ID de Telegram</label>
                        <div class="search-container">
                            <input type="text" id="userSearchInput" placeholder="Ej: 123456789">
                            <button id="searchUserBtn" class="search-btn"><i class="fas fa-search"></i> Buscar</button>
                        </div>
                    </div>
                    
                    <div id="userSearchResult" class="user-search-result" style="display: none;">
                        <!-- Los resultados de b√∫squeda aparecer√°n aqu√≠ -->
                    </div>
                    
                    <div class="user-actions" id="userActions" style="display: none;">
                        <button id="makeVipBtn" class="admin-btn btn-vip"><i class="fas fa-crown"></i> Hacer VIP</button>
                        <button id="removeVipBtn" class="admin-btn btn-loss"><i class="fas fa-times"></i> Quitar VIP</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="asset"><i class="fas fa-chart-line"></i> Activo</label>
                    <input type="text" id="asset" placeholder="Ej: EUR/USD, BTC/USD, etc.">
                </div>
                <div class="form-group">
                    <label for="timeframe"><i class="fas fa-clock"></i> Tiempo</label>
                    <select id="timeframe">
                        <option value="1">1 minuto</option>
                        <option value="2">2 minutos</option>
                        <option value="5">5 minutos</option>
                        <option value="15">15 minutos</option>
                        <option value="30">30 minutos</option>
                        <option value="60">1 hora</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="direction"><i class="fas fa-arrows-alt-v"></i> Direcci√≥n</label>
                    <select id="direction">
                        <option value="up">ALZA (CALL)</option>
                        <option value="down">BAJA (PUT)</option>
                    </select>
                </div>
                <button id="sendSignal"><i class="fas fa-paper-plane"></i> ENVIAR SE√ëAL</button>
                <div class="admin-controls" style="margin-top: 20px;">
                    <button id="startSession" class="admin-btn btn-profit"><i class="fas fa-play"></i> Iniciar Sesi√≥n</button>
                    <button id="endSession" class="admin-btn btn-loss" disabled><i class="fas fa-stop"></i> Finalizar Sesi√≥n</button>
                </div>
                <div class="admin-controls" style="margin-top: 10px;">
                    <button id="notifyClients" class="admin-btn btn-notify"><i class="fas fa-bell"></i> Avisar al Cliente (10 min)</button>
                </div>
            </div>
            
            <div class="panel signals-panel">
                <h3><i class="fas fa-broadcast-tower"></i> Se√±ales Activas</h3>
                <button id="readyBtn" class="ready-btn">
                    <i class="fas fa-bell"></i> PREPARADOS
                </button>
                <div class="user-status" id="userStatus">
                    <div class="session-info">
                        <i class="fas fa-user"></i> Estado: Cargando informaci√≥n del usuario...
                    </div>
                </div>
                <div id="signalsContainer">
                    <div class="empty-state">
                        <i class="fas fa-satellite-dish"></i>
                        <p>Esperando se√±ales de trading...</p>
                        <p>Las se√±ales aparecer√°n aqu√≠ autom√°ticamente</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <div class="panel stats-panel">
                <h3><i class="fas fa-chart-bar"></i> Estad√≠sticas de Trading</h3>
                
                <div class="time-filters">
                    <button class="time-filter active" data-period="day">Hoy</button>
                    <button class="time-filter" data-period="week">Esta Semana</button>
                    <button class="time-filter" data-period="month">Este Mes</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Operaciones Ganadas</div>
                        <div class="stat-value stat-profit" id="winCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Operaciones Perdidas</div>
                        <div class="stat-value stat-loss" id="lossCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Operaciones</div>
                        <div class="stat-value stat-total" id="totalCount">0</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
                
                <h3 style="margin-top: 30px;"><i class="fas fa-history"></i> Historial de Operaciones</h3>
                <div style="overflow-x: auto;">
                    <table class="operations-table">
                        <thead>
                            <tr>
                                <th>Activo</th>
                                <th>Direcci√≥n</th>
                                <th>Tiempo</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTable">
                            <!-- Las operaciones se insertar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="users-container" id="usersContainer">
            <div class="panel users-panel">
                <h3><i class="fas fa-users"></i> Gesti√≥n de Usuarios</h3>
                
                <div class="admin-controls" style="margin-bottom: 20px;">
                    <button id="refreshUsers" class="admin-btn btn-profit"><i class="fas fa-sync-alt"></i> Actualizar Lista</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID de Telegram</th>
                                <th>Usuario</th>
                                <th>Estado VIP</th>
                                <th>Expiraci√≥n VIP</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Los usuarios se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-bell"></i> Nueva se√±al recibida!
    </div>
    
    <div class="signal-alert" id="signalAlert">
        <div class="asset" id="alertAsset">EUR/USD</div>
        <div class="direction up" id="alertDirection">
            <span class="arrow up">‚Üë</span>
            <span>ALZA (CALL)</span>
        </div>
        <div class="time-remaining" id="alertTime">Expira en: 1:00</div>
        <button id="closeAlert" style="margin-top: 20px;">ENTENDIDO</button>
    </div>

    <div class="modal" id="vipModal">
        <div class="modal-content">
            <h3 style="color: var(--vip); margin-bottom: 20px; text-align: center;">
                <i class="fas fa-crown"></i> Acceso VIP - 5000 CUP/mes
            </h3>
            <div style="text-align: left; margin: 20px 0; color: var(--text);">
                <p style="margin-bottom: 15px;"><i class="fas fa-check" style="color: var(--accent);"></i> Acceso a TODAS las se√±ales sin l√≠mites</p>
                <p style="margin-bottom: 15px;"><i class="fas fa-check" style="color: var(--accent);"></i> Se√±ales en tiempo real VIP</p>
                <p style="margin-bottom: 15px;"><i class="fas fa-check" style="color: var(--accent);"></i> Soporte prioritario 24/7</p>
                <p style="margin-bottom: 15px;"><i class="fas fa-check" style="color: var(--accent);"></i> Estad√≠sticas avanzadas personalizadas</p>
                <p style="margin-bottom: 15px;"><i class="fas fa-check" style="color: var(--accent);"></i> Alertas instant√°neas exclusivas</p>
                <p style="margin-bottom: 20px;"><i class="fas fa-check" style="color: var(--accent);"></i> Se√±ales antes que los usuarios free</p>
            </div>
            <p style="text-align: center; margin: 20px 0; color: var(--text-secondary);">
                Duraci√≥n: 30 d√≠as completos
            </p>
            <div style="text-align: center; margin: 25px 0;">
                <a href="https://t.me/Asche90" target="_blank" style="display: inline-block; background: linear-gradient(90deg, var(--vip), #ff9900); color: var(--dark); padding: 14px 30px; border-radius: 8px; font-weight: 700; text-decoration: none; transition: all 0.3s ease; font-size: 1.1rem;">
                    <i class="fab fa-telegram"></i> Contactar al administrador
                </a>
            </div>
            <p style="text-align: center; margin: 15px 0; color: var(--text-secondary); font-size: 0.9rem;">
                Env√≠ale un mensaje solicitando el plan VIP
            </p>
            <button id="closeVipModal" style="background: transparent; border: 1px solid var(--vip); color: var(--vip); margin-top: 10px;">
                CERRAR
            </button>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN GLOBAL Y DETECCI√ìN DE USUARIO
        // =============================================
        
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://flodrkrvaqsmelbkfknv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsb2Rya3J2YXFzbWVsYmtma252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwODY0NjgsImV4cCI6MjA3OTY2MjQ2OH0.zVTaUbkiLCJ0dUFs808TZErgnIXCYsYQ2lw-CEmVCFI';
        
        // Inicializar cliente de Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // URL del servidor (mismo dominio)
        const SERVER_URL = window.location.origin;
        
        // ID del administrador
        const ADMIN_ID = "5376388604";
        
        // Variable global para el manager
        let signalManager = null;

        // =============================================
        // FUNCI√ìN PRINCIPAL DE DETECCI√ìN DE USER ID
        // =============================================
        
        function getUserIdSuperRobust() {
            console.log('üîç [USER_ID] Iniciando detecci√≥n de User ID');
            
            // 1. PRIMERA PRIORIDAD: tgid de la URL (m√°s confiable)
            const urlParams = new URLSearchParams(window.location.search);
            const tgId = urlParams.get('tgid');
            if (tgId) {
                console.log('üéØ [USER_ID] ID obtenido desde tgid URL:', tgId);
                return tgId;
            }
            
            // 2. SEGUNDA OPCI√ìN: Telegram Web App SDK
            if (window.Telegram && window.Telegram.WebApp) {
                console.log('üîß [TELEGRAM] Telegram Web App SDK detectado');
                const tg = window.Telegram.WebApp;
                tg.expand();
                
                const user = tg.initDataUnsafe?.user;
                if (user && user.id) {
                    console.log('üéØ [USER_ID] ID obtenido desde SDK:', user.id);
                    return user.id.toString();
                }
            }
            
            // 3. TERCERA OPCI√ìN: Fragmento de URL (tgWebAppData)
            try {
                const fragment = window.location.hash.substring(1);
                if (fragment) {
                    const fragmentParams = new URLSearchParams(fragment);
                    const tgWebAppData = fragmentParams.get('tgWebAppData');
                    
                    if (tgWebAppData) {
                        console.log('üîç [TELEGRAM] Procesando tgWebAppData del fragmento');
                        const decodedWebAppData = decodeURIComponent(tgWebAppData);
                        const webAppParams = new URLSearchParams(decodedWebAppData);
                        const userString = webAppParams.get('user');
                        
                        if (userString) {
                            const userData = JSON.parse(decodeURIComponent(userString));
                            if (userData && userData.id) {
                                console.log('üéØ [USER_ID] ID obtenido desde fragmento:', userData.id);
                                return userData.id.toString();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå [TELEGRAM] Error parseando fragmento:', error);
            }
            
            // 4. CUARTA OPCI√ìN: localStorage
            const storedId = localStorage.getItem('tg_user_id');
            if (storedId) {
                console.log('üéØ [USER_ID] ID obtenido desde localStorage:', storedId);
                return storedId;
            }
            
            // 5. √öLTIMO RECURSO: Generar guest ID
            const guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
            console.log('‚ö†Ô∏è [USER_ID] Generando ID de guest:', guestId);
            return guestId;
        }

        // =============================================
        // INICIALIZACI√ìN INMEDIATA DEL USER ID
        // =============================================
        
        // Detectar User ID inmediatamente al cargar la p√°gina
        const detectedUserId = getUserIdSuperRobust();
        console.log('üöÄ [APP] User ID detectado al inicio:', detectedUserId);
        
        // Guardar en localStorage inmediatamente
        if (detectedUserId && !detectedUserId.startsWith('guest_')) {
            localStorage.setItem('tg_user_id', detectedUserId);
            console.log('üíæ [APP] User ID guardado en localStorage');
        }

        // =============================================
        // SISTEMA DE PART√çCULAS
        // =============================================
        
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const left = Math.random() * 100;
                const delay = Math.random() * 15;
                const duration = 15 + Math.random() * 10;
                
                particle.style.left = `${left}%`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                const size = 2 + Math.random() * 3;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                const colors = ['var(--primary)', 'var(--secondary)', 'var(--accent)'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.background = color;
                
                particlesContainer.appendChild(particle);
            }
        }

        // =============================================
        // CLASE PRINCIPAL SIGNAL MANAGER
        // =============================================
        
        class SignalManager {
            constructor() {
                this.signals = [];
                this.operations = [];
                this.sessions = [];
                this.currentSession = null;
                this.isAdmin = false;
                this.isVIP = false;
                this.hasReceivedFreeSignal = false;
                this.serverConnected = false;
                
                // Usar el User ID ya detectado globalmente
                this.currentUserId = detectedUserId;
                this.userData = null;
                this.searchedUser = null;
                
                console.log('üöÄ [APP] Inicializando SignalManager con User ID:', this.currentUserId);
                
                // Inicializaci√≥n inmediata
                this.initializeDOMElements();
                this.initEventListeners();
                this.loadFromLocalStorage();
                this.updateStats();
                this.initChart();
                
                // Detectar admin inmediatamente
                this.detectAdminStatus();
                
                // Cargar datos del usuario
                this.loadUserData();
                this.setupRealtimeSubscription();
                this.checkServerConnection();
                
                setInterval(() => this.checkServerConnection(), 30000);
                
                // Actualizar UI inmediatamente
                this.updateUI();
            }
            
            // Detectar si es admin basado en el User ID
            detectAdminStatus() {
                if (this.currentUserId === ADMIN_ID) {
                    this.isAdmin = true;
                    console.log('üéØ [APP] Usuario identificado como ADMIN');
                }
            }
            
            async loadUserData() {
                if (!this.currentUserId || this.currentUserId.startsWith('guest_')) {
                    console.log('‚ùå [APP] No hay User ID v√°lido para cargar datos');
                    this.updateUserStatus();
                    return;
                }
                
                try {
                    console.log('üîç [APP] Cargando datos del usuario:', this.currentUserId);
                    const apiUrl = `${SERVER_URL}/api/user/${this.currentUserId}`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.userData = result.data;
                        this.isAdmin = result.data.is_admin || this.isAdmin;
                        this.isVIP = result.data.is_vip;
                        
                        // Verificar si el VIP ha expirado
                        if (this.isVIP && this.userData.vip_expires_at) {
                            const expiryDate = new Date(this.userData.vip_expires_at);
                            if (expiryDate < new Date()) {
                                this.isVIP = false;
                                console.log('‚ö†Ô∏è [APP] VIP expirado');
                            }
                        }
                        
                        console.log('‚úÖ [APP] Datos de usuario cargados:', {
                            id: this.currentUserId,
                            admin: this.isAdmin,
                            vip: this.isVIP
                        });
                    } else {
                        console.error('‚ùå [APP] Error en respuesta del servidor:', result);
                    }
                } catch (error) {
                    console.error('‚ùå [APP] Error cargando datos del usuario:', error);
                } finally {
                    this.updateUI();
                }
            }
            
            updateUI() {
                console.log('üîÑ [APP] Actualizando UI con UserID:', this.currentUserId);
                
                // Mostrar el ID del usuario inmediatamente
                const userIdDisplay = document.getElementById('userIdDisplay');
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID: ${this.currentUserId}`;
                    if (this.isAdmin) {
                        userIdDisplay.innerHTML += ' <span style="color: var(--primary);">(Admin)</span>';
                    } else if (this.isVIP) {
                        userIdDisplay.innerHTML += ' <span style="color: var(--vip);">(VIP)</span>';
                    }
                }

                // Actualizar estado del usuario
                this.updateUserStatus();
                
                // Mostrar/ocultar panel de admin
                if (this.isAdmin) {
                    this.adminBtn.style.display = 'block';
                    this.adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> Panel Admin';
                    this.adminBtn.classList.add('active');
                    this.adminPanel.style.display = 'block';
                    this.showUsers.style.display = 'block';
                    this.loadUsersFromSupabase();
                } else {
                    this.adminBtn.style.display = 'none';
                    this.adminPanel.style.display = 'none';
                    this.showUsers.style.display = 'none';
                }
                
                // Actualizar estado VIP
                if (this.isVIP) {
                    this.vipAccess.innerHTML = '<i class="fas fa-crown"></i> VIP ACTIVO';
                    this.vipAccess.classList.add('active');
                } else {
                    this.vipAccess.innerHTML = '<i class="fas fa-crown"></i> VIP';
                    this.vipAccess.classList.remove('active');
                }
                
                // Actualizar panel de debug
                this.updateDebugPanel();
            }

            initializeDOMElements() {
                console.log('üèóÔ∏è [APP] Inicializando elementos DOM');
                
                this.sendSignalBtn = document.getElementById('sendSignal');
                this.signalsContainer = document.getElementById('signalsContainer');
                this.notification = document.getElementById('notification');
                this.signalAlert = document.getElementById('signalAlert');
                this.readyBtn = document.getElementById('readyBtn');
                this.closeAlert = document.getElementById('closeAlert');
                this.showSignals = document.getElementById('showSignals');
                this.showStats = document.getElementById('showStats');
                this.showUsers = document.getElementById('showUsers');
                this.vipAccess = document.getElementById('vipAccess');
                this.adminBtn = document.getElementById('adminBtn');
                this.statsContainer = document.getElementById('statsContainer');
                this.usersContainer = document.getElementById('usersContainer');
                this.sessionInfo = document.getElementById('sessionInfo');
                this.userStatus = document.getElementById('userStatus');
                this.startSession = document.getElementById('startSession');
                this.endSession = document.getElementById('endSession');
                this.notifyClients = document.getElementById('notifyClients');
                this.vipModal = document.getElementById('vipModal');
                this.closeVipModal = document.getElementById('closeVipModal');
                this.adminPanel = document.getElementById('adminPanel');
                this.usersTableBody = document.getElementById('usersTableBody');
                this.refreshUsers = document.getElementById('refreshUsers');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.statusDot = document.getElementById('statusDot');
                this.statusText = document.getElementById('statusText');
                
                // Elementos para gesti√≥n de usuarios
                this.userSearchInput = document.getElementById('userSearchInput');
                this.searchUserBtn = document.getElementById('searchUserBtn');
                this.userSearchResult = document.getElementById('userSearchResult');
                this.makeVipBtn = document.getElementById('makeVipBtn');
                this.removeVipBtn = document.getElementById('removeVipBtn');
                this.userActions = document.getElementById('userActions');
                
                this.isReady = false;
                
                // Estad√≠sticas
                this.winCount = document.getElementById('winCount');
                this.lossCount = document.getElementById('lossCount');
                this.totalCount = document.getElementById('totalCount');
                this.operationsTable = document.getElementById('operationsTable');
                this.performanceChart = null;
                
                // Crear panel de debug
                this.createDebugPanel();
            }
            
            createDebugPanel() {
                let debugDiv = document.getElementById('debugInfo');
                if (!debugDiv) {
                    debugDiv = document.createElement('div');
                    debugDiv.id = 'debugInfo';
                    debugDiv.style.cssText = 'position:fixed; top:10px; right:10px; background:rgba(255,0,0,0.9); color:white; padding:10px; z-index:10000; font-size:12px; border-radius:5px; max-width:300px; word-break: break-all;';
                    document.body.appendChild(debugDiv);
                }
                this.debugDiv = debugDiv;
                this.updateDebugPanel();
            }
            
            updateDebugPanel() {
                if (!this.debugDiv) return;
                
                const urlParams = new URLSearchParams(window.location.search);
                const tgid = urlParams.get('tgid');
                
                let telegramSDK = '‚ùå';
                let sdkUser = 'NO';
                if (window.Telegram && window.Telegram.WebApp) {
                    telegramSDK = '‚úÖ';
                    sdkUser = window.Telegram.WebApp.initDataUnsafe?.user?.id || 'NO';
                }
                
                this.debugDiv.innerHTML = `
                    <strong>üîç DEBUG INFO ACTUALIZADO</strong><br>
                    <strong>URL tgid:</strong> ${tgid || 'NO'}<br>
                    <strong>UserID actual:</strong> ${this.currentUserId || 'NO'}<br>
                    <strong>Telegram SDK:</strong> ${telegramSDK} (${sdkUser})<br>
                    <strong>isAdmin:</strong> ${this.isAdmin}<br>
                    <strong>isVIP:</strong> ${this.isVIP}<br>
                    <strong>Estrategia:</strong> PRIORIDAD tgid ‚Üí SDK ‚Üí Parser
                `;
            }
            
            async checkServerConnection() {
                try {
                    const response = await fetch(`${SERVER_URL}/health`);
                    if (response.ok) {
                        this.serverConnected = true;
                        this.updateConnectionStatus(true, 'Conectado al servidor');
                    } else {
                        throw new Error('Server not responding');
                    }
                } catch (error) {
                    this.serverConnected = false;
                    this.updateConnectionStatus(false, 'Error de conexi√≥n con el servidor');
                    console.error('Error checking server connection:', error);
                }
            }
            
            updateConnectionStatus(connected, message) {
                if (connected) {
                    this.statusDot.className = 'status-dot status-connected';
                    this.statusText.textContent = message;
                    this.connectionStatus.style.background = 'rgba(0, 255, 157, 0.1)';
                } else {
                    this.statusDot.className = 'status-dot status-disconnected';
                    this.statusText.textContent = message;
                    this.connectionStatus.style.background = 'rgba(255, 0, 51, 0.1)';
                }
            }
            
            initEventListeners() {
                // Evento para enviar se√±ales
                this.sendSignalBtn.addEventListener('click', () => {
                    this.sendSignal();
                });
                
                this.readyBtn.addEventListener('click', () => {
                    this.toggleReady();
                });
                
                this.closeAlert.addEventListener('click', () => {
                    this.hideAlert();
                });
                
                this.showSignals.addEventListener('click', () => {
                    this.showSignalsView();
                });
                
                this.showStats.addEventListener('click', () => {
                    this.showStatsView();
                });
                
                this.showUsers.addEventListener('click', () => {
                    this.showUsersView();
                });
                
                this.vipAccess.addEventListener('click', () => {
                    this.showVipModal();
                });
                
                this.adminBtn.addEventListener('click', () => {
                    if (this.isAdmin) {
                        this.showAdminPanel();
                    }
                });
                
                this.startSession.addEventListener('click', () => {
                    this.startTradingSession();
                });
                
                this.endSession.addEventListener('click', () => {
                    this.endTradingSession();
                });
                
                this.notifyClients.addEventListener('click', () => {
                    this.sendClientNotification();
                });
                
                this.closeVipModal.addEventListener('click', () => {
                    this.hideVipModal();
                });
                
                this.refreshUsers.addEventListener('click', () => {
                    this.loadUsersFromSupabase();
                });

                // Event listeners para gesti√≥n de usuarios
                this.searchUserBtn.addEventListener('click', () => {
                    this.searchUser();
                });
                
                this.makeVipBtn.addEventListener('click', () => {
                    this.makeUserVip();
                });
                
                this.removeVipBtn.addEventListener('click', () => {
                    this.removeUserVip();
                });
                
                // Filtros de tiempo para estad√≠sticas
                document.querySelectorAll('.time-filter').forEach(filter => {
                    filter.addEventListener('click', () => {
                        document.querySelectorAll('.time-filter').forEach(f => f.classList.remove('active'));
                        filter.classList.add('active');
                        this.updateStats(filter.dataset.period);
                    });
                });
            }

            // ... (el resto de los m√©todos se mantienen igual)
            // M√©todos para gesti√≥n de usuarios
            async searchUser() {
                const searchId = this.userSearchInput.value.trim();
                if (!searchId) {
                    alert('Por favor, ingresa un ID de Telegram');
                    return;
                }

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/search/${searchId}`);
                    const result = await response.json();

                    if (result.success) {
                        this.searchedUser = result.data;
                        this.displayUserSearchResult();
                    } else {
                        this.userSearchResult.innerHTML = '<p class="error">Error al buscar usuario</p>';
                        this.userSearchResult.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error buscando usuario:', error);
                    this.userSearchResult.innerHTML = '<p class="error">Error al buscar usuario</p>';
                    this.userSearchResult.style.display = 'block';
                }
            }

            displayUserSearchResult() {
                if (!this.searchedUser) {
                    this.userSearchResult.innerHTML = `
                        <div class="user-not-found">
                            <i class="fas fa-user-times"></i>
                            <p>Usuario no encontrado</p>
                            <p>El ID ${this.userSearchInput.value} no est√° registrado en el sistema</p>
                        </div>
                    `;
                } else {
                    const isVip = this.searchedUser.is_vip;
                    const vipExpires = this.searchedUser.vip_expires_at ? new Date(this.searchedUser.vip_expires_at) : null;
                    const now = new Date();
                    const daysLeft = vipExpires ? Math.ceil((vipExpires - now) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let vipStatus = 'No VIP';
                    let daysLeftHtml = '';
                    
                    if (isVip && vipExpires && vipExpires > now) {
                        vipStatus = 'Usuario VIP';
                        daysLeftHtml = `<div class="vip-time-remaining">Tiempo restante: <span class="days-left">${daysLeft} d√≠as</span></div>`;
                    } else if (isVip && vipExpires && vipExpires <= now) {
                        vipStatus = 'VIP Expirado';
                    }

                    this.userSearchResult.innerHTML = `
                        <div class="user-found">
                            <div class="user-header">
                                <i class="fas fa-user"></i>
                                <h4>Usuario Encontrado</h4>
                            </div>
                            <div class="user-details">
                                <p><strong>ID:</strong> ${this.searchedUser.telegram_id}</p>
                                <p><strong>Nombre:</strong> ${this.searchedUser.first_name || 'No especificado'}</p>
                                <p><strong>Usuario:</strong> @${this.searchedUser.username || 'No especificado'}</p>
                                <p><strong>Estado:</strong> <span class="user-status ${isVip && vipExpires > now ? 'vip' : 'regular'}">${vipStatus}</span></p>
                                ${daysLeftHtml}
                            </div>
                        </div>
                    `;

                    // Mostrar botones seg√∫n el estado VIP
                    this.userActions.style.display = 'flex';
                    this.makeVipBtn.style.display = (!isVip || (vipExpires && vipExpires <= now)) ? 'block' : 'none';
                    this.removeVipBtn.style.display = (isVip && vipExpires && vipExpires > now) ? 'block' : 'none';
                }

                this.userSearchResult.style.display = 'block';
            }

            async makeUserVip() {
                if (!this.searchedUser) return;

                const days = prompt('¬øPor cu√°ntos d√≠as quieres hacer VIP al usuario?', '30');
                if (!days || isNaN(days)) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: this.searchedUser.telegram_id,
                            userId: this.currentUserId,
                            days: parseInt(days)
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        // Recargar la informaci√≥n del usuario
                        await this.searchUser();
                    } else {
                        this.showNotification('Error al hacer VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error haciendo usuario VIP:', error);
                    this.showNotification('Error al hacer VIP al usuario', 'error');
                }
            }

            async removeUserVip() {
                if (!this.searchedUser) return;

                if (!confirm('¬øEst√°s seguro de que quieres quitar el VIP a este usuario?')) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/remove-vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: this.searchedUser.telegram_id,
                            userId: this.currentUserId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        // Recargar la informaci√≥n del usuario
                        await this.searchUser();
                    } else {
                        this.showNotification('Error al quitar VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error quitando VIP:', error);
                    this.showNotification('Error al quitar VIP al usuario', 'error');
                }
            }
            
            async loadSignalsFromSupabase() {
                try {
                    const { data, error } = await supabase
                        .from('signals')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(20);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        this.signals = data.map(signal => ({
                            id: signal.id,
                            asset: signal.asset,
                            timeframe: signal.timeframe,
                            direction: signal.direction,
                            timestamp: new Date(signal.created_at),
                            expires: new Date(signal.expires_at),
                            status: signal.status || 'pending',
                            isFree: signal.is_free || false
                        }));
                        
                        this.operations = [...this.signals];
                        this.renderSignals();
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Error loading signals from Supabase:', error);
                }
            }
            
            async loadUsersFromSupabase() {
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    if (data) {
                        this.renderUsers(data);
                    }
                } catch (error) {
                    console.error('Error loading users from Supabase:', error);
                }
            }
            
            renderUsers(users) {
                this.usersTableBody.innerHTML = users.map(user => {
                    const isVip = user.is_vip;
                    const vipExpires = user.vip_expires_at ? new Date(user.vip_expires_at) : null;
                    const now = new Date();
                    const expiresIn = vipExpires ? Math.ceil((vipExpires - now) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let vipStatus = 'No VIP';
                    let daysLeftClass = '';
                    
                    if (isVip && vipExpires && vipExpires > now) {
                        vipStatus = `VIP - Expira en <span class="days-left ${expiresIn <= 5 ? 'danger' : (expiresIn <= 15 ? 'warning' : '')}">${expiresIn} d√≠as</span>`;
                    } else if (isVip && vipExpires && vipExpires <= now) {
                        vipStatus = 'VIP Expirado';
                    }
                    
                    return `
                        <tr>
                            <td>${user.telegram_id}</td>
                            <td>${user.username || user.first_name || 'N/A'}</td>
                            <td>${vipStatus}</td>
                            <td>${vipExpires ? vipExpires.toLocaleDateString() : 'N/A'}</td>
                            <td class="user-actions">
                                ${!isVip || (vipExpires && vipExpires <= now) ? 
                                    `<button class="user-action-btn btn-profit" onclick="signalManager.makeVip('${user.telegram_id}')">Hacer VIP</button>` : 
                                    `<button class="user-action-btn btn-loss" onclick="signalManager.removeVip('${user.telegram_id}')">Quitar VIP</button>`
                                }
                                ${isVip && vipExpires && vipExpires > now && expiresIn <= 5 ? 
                                    `<button class="user-action-btn btn-notify" onclick="signalManager.notifyVipExpiring('${user.telegram_id}')">Notificar (5 d√≠as)</button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            async makeVip(telegramId) {
                const days = prompt('¬øPor cu√°ntos d√≠as quieres hacer VIP al usuario?', '30');
                if (!days || isNaN(days)) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: telegramId,
                            userId: this.currentUserId,
                            days: parseInt(days)
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        this.loadUsersFromSupabase();
                    } else {
                        this.showNotification('Error al hacer VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error haciendo usuario VIP:', error);
                    this.showNotification('Error al hacer VIP al usuario', 'error');
                }
            }
            
            async removeVip(telegramId) {
                if (!confirm('¬øEst√°s seguro de que quieres quitar el VIP a este usuario?')) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/remove-vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: telegramId,
                            userId: this.currentUserId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        this.loadUsersFromSupabase();
                    } else {
                        this.showNotification('Error al quitar VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error quitando VIP:', error);
                    this.showNotification('Error al quitar VIP al usuario', 'error');
                }
            }
            
            async notifyVipExpiring(telegramId) {
                this.showNotification(`Notificaci√≥n enviada al usuario ${telegramId} sobre su VIP pr√≥ximo a expirar.`, 'success');
            }
            
            setupRealtimeSubscription() {
                supabase
                    .channel('signals-channel')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'signals' 
                        }, 
                        (payload) => {
                            console.log('Nueva se√±al recibida:', payload);
                            this.handleNewSignal(payload.new);
                        }
                    )
                    .on('postgres_changes', 
                        { 
                            event: 'UPDATE', 
                            schema: 'public', 
                            table: 'signals' 
                        }, 
                        (payload) => {
                            console.log('Se√±al actualizada:', payload);
                            this.handleUpdatedSignal(payload.new);
                        }
                    )
                    .subscribe();
            }
            
            handleNewSignal(signalData) {
                const signal = {
                    id: signalData.id,
                    asset: signalData.asset,
                    timeframe: signalData.timeframe,
                    direction: signalData.direction,
                    timestamp: new Date(signalData.created_at),
                    expires: new Date(signalData.expires_at),
                    status: signalData.status || 'pending',
                    isFree: signalData.is_free || false
                };
                
                const canReceiveSignal = this.isVIP || signal.isFree;
                
                if (canReceiveSignal) {
                    this.signals.unshift(signal);
                    this.operations.unshift(signal);
                    this.renderSignals();
                    this.showNotification('Nueva se√±al recibida!', 'success');
                    
                    if (this.isReady) {
                        this.showAlert(signal);
                    }
                } else {
                    this.showNotification('Se√±al VIP enviada (solo para usuarios VIP)', 'info');
                }
                
                this.updateStats();
            }
            
            handleUpdatedSignal(signalData) {
                const signalIndex = this.signals.findIndex(s => s.id === signalData.id);
                const operationIndex = this.operations.findIndex(o => o.id === signalData.id);
                
                if (signalIndex !== -1) {
                    this.signals[signalIndex].status = signalData.status;
                }
                
                if (operationIndex !== -1) {
                    this.operations[operationIndex].status = signalData.status;
                }
                
                this.renderSignals();
                this.updateStats();
            }
            
            showVipModal() {
                this.vipModal.classList.add('active');
            }
            
            hideVipModal() {
                this.vipModal.classList.remove('active');
            }
            
            showAdminPanel() {
                this.adminPanel.style.display = this.adminPanel.style.display === 'none' ? 'block' : 'none';
            }
            
            updateUserStatus() {
                if (this.isVIP) {
                    this.userStatus.innerHTML = `
                        <div class="session-info" style="border-color: var(--vip);">
                            <i class="fas fa-crown"></i> Estado: <span class="vip-badge">USUARIO VIP</span> - Recibiendo todas las se√±ales
                        </div>
                    `;
                } else if (this.isAdmin) {
                    this.userStatus.innerHTML = `
                        <div class="session-info" style="border-color: var(--primary);">
                            <i class="fas fa-user-shield"></i> Estado: <span style="color: var(--primary); font-weight: bold;">ADMINISTRADOR</span> - Acceso completo al sistema
                        </div>
                    `;
                } else {
                    this.userStatus.innerHTML = `
                        <div class="session-info">
                            <i class="fas fa-user"></i> Estado: Usuario Regular - Solo primera se√±al gratuita por sesi√≥n
                        </div>
                    `;
                }
            }
            
            async startTradingSession() {
                try {
                    const response = await fetch(`${SERVER_URL}/api/sessions/start`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.hasReceivedFreeSignal = false;
                        
                        this.currentSession = {
                            id: Date.now(),
                            startTime: new Date(),
                            endTime: null,
                            signals: []
                        };
                        
                        this.startSession.disabled = true;
                        this.endSession.disabled = false;
                        
                        this.sessionInfo.innerHTML = `
                            <i class="fas fa-play-circle"></i> Sesi√≥n activa - Iniciada: ${this.currentSession.startTime.toLocaleTimeString()}
                        `;
                        this.sessionInfo.classList.add('session-active');
                        
                        this.showNotification('Sesi√≥n de trading iniciada', 'success');
                    } else {
                        throw new Error('Error iniciando sesi√≥n');
                    }
                } catch (error) {
                    console.error('Error iniciando sesi√≥n:', error);
                    this.showNotification('Error al iniciar sesi√≥n', 'error');
                }
            }
            
            async endTradingSession() {
                if (!this.currentSession) return;
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/sessions/end`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.currentSession.endTime = new Date();
                        this.sessions.push(this.currentSession);
                        
                        this.startSession.disabled = false;
                        this.endSession.disabled = true;
                        
                        this.sessionInfo.innerHTML = `
                            <i class="fas fa-stop-circle"></i> Sesi√≥n finalizada - Duraci√≥n: ${this.getSessionDuration(this.currentSession)}
                        `;
                        this.sessionInfo.classList.remove('session-active');
                        
                        this.currentSession = null;
                        
                        this.saveToLocalStorage();
                        this.updateStats();
                        
                        this.showNotification('Sesi√≥n de trading finalizada', 'info');
                    } else {
                        throw new Error('Error finalizando sesi√≥n');
                    }
                } catch (error) {
                    console.error('Error finalizando sesi√≥n:', error);
                    this.showNotification('Error al finalizar sesi√≥n', 'error');
                }
            }
            
            getSessionDuration(session) {
                const endTime = session.endTime || new Date();
                const duration = endTime - session.startTime;
                const minutes = Math.floor(duration / 60000);
                const seconds = ((duration % 60000) / 1000).toFixed(0);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }
            
            async sendClientNotification() {
                try {
                    const response = await fetch(`${SERVER_URL}/api/notify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.showNotification('Notificaci√≥n enviada a los clientes', 'success');
                        
                        if (this.isReady) {
                            this.showClientAlert();
                        }
                    } else {
                        throw new Error('Error enviando notificaci√≥n');
                    }
                } catch (error) {
                    console.error('Error enviando notificaci√≥n:', error);
                    this.showNotification('Error al enviar notificaci√≥n', 'error');
                }
            }
            
            showClientAlert() {
                const alert = document.createElement('div');
                alert.className = 'signal-alert';
                alert.innerHTML = `
                    <div class="asset" style="color: var(--warning);">ATENCI√ìN</div>
                    <div class="direction" style="background: rgba(255, 204, 0, 0.15); color: var(--warning); border: 1px solid var(--warning);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Sesi√≥n en 10 minutos</span>
                    </div>
                    <div class="time-remaining" style="background: rgba(255, 204, 0, 0.1); color: var(--warning);">
                        La sesi√≥n de trading comenzar√° en 10 minutos. Prep√°rate!
                    </div>
                    <button id="closeClientAlert" style="margin-top: 20px; background: var(--warning); color: var(--dark);">ENTENDIDO</button>
                `;
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    alert.classList.add('show');
                }, 100);
                
                const closeBtn = alert.querySelector('#closeClientAlert');
                closeBtn.addEventListener('click', () => {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(alert);
                    }, 500);
                });
            }
            
            toggleReady() {
                this.isReady = !this.isReady;
                if (this.isReady) {
                    this.readyBtn.innerHTML = '<i class="fas fa-check"></i> LISTOS';
                    this.readyBtn.classList.add('ready');
                    this.showNotification('Estado cambiado a LISTOS - Recibir√°s alertas de se√±ales', 'success');
                } else {
                    this.readyBtn.innerHTML = '<i class="fas fa-bell"></i> PREPARADOS';
                    this.readyBtn.classList.remove('ready');
                    this.showNotification('Estado cambiado a PREPARADOS', 'info');
                }
            }
            
            async sendSignal() {
                const asset = document.getElementById('asset').value;
                const timeframe = document.getElementById('timeframe').value;
                const direction = document.getElementById('direction').value;
                
                if(!asset) {
                    alert('Por favor, ingresa un activo');
                    return;
                }
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/signals`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            asset: asset.toUpperCase(),
                            timeframe: parseInt(timeframe),
                            direction: direction,
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.hasReceivedFreeSignal = true;
                        document.getElementById('asset').value = '';
                        
                        this.showNotification('Se√±al enviada correctamente', 'success');
                        
                        console.log('Se√±al enviada:', result);
                    } else {
                        throw new Error('Error enviando se√±al');
                    }
                } catch (error) {
                    console.error('Error enviando se√±al:', error);
                    alert('Error al enviar la se√±al. Por favor, int√©ntalo de nuevo.');
                }
            }
            
            async updateOperationStatus(operationId, status) {
                try {
                    const response = await fetch(`${SERVER_URL}/api/signals/${operationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: status,
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.showNotification(`Estado cambiado a: ${status}`, 'info');
                    } else {
                        throw new Error('Error actualizando estado');
                    }
                } catch (error) {
                    console.error('Error actualizando estado:', error);
                    alert('Error al actualizar el estado. Por favor, int√©ntalo de nuevo.');
                }
            }
            
            renderSignals() {
                if(this.signals.length === 0) {
                    this.signalsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-satellite-dish"></i>
                            <p>Esperando se√±ales de trading...</p>
                            <p>Las se√±ales aparecer√°n aqu√≠ autom√°ticamente</p>
                        </div>
                    `;
                    return;
                }
                
                this.signalsContainer.innerHTML = this.signals.map(signal => {
                    const expiresDate = new Date(signal.expires);
                    const timeRemaining = Math.max(0, Math.floor((expiresDate - new Date()) / 1000));
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    const isExpired = timeRemaining <= 0;
                    
                    let statusClass = 'status-pending';
                    let statusText = 'PENDIENTE';
                    let statusIcon = '<i class="fas fa-clock"></i>';
                    let resultBadge = '';
                    
                    if (signal.status === 'profit') {
                        statusClass = 'status-profit';
                        statusText = 'GANADA';
                        statusIcon = '<i class="fas fa-check-circle"></i>';
                        resultBadge = '<div class="operation-result result-profit">PROFIT</div>';
                    } else if (signal.status === 'loss') {
                        statusClass = 'status-loss';
                        statusText = 'PERDIDA';
                        statusIcon = '<i class="fas fa-times-circle"></i>';
                        resultBadge = '<div class="operation-result result-loss">LOSS</div>';
                    } else if (isExpired) {
                        statusClass = 'status-pending';
                        statusText = 'EXPIRADA';
                        statusIcon = '<i class="fas fa-hourglass-end"></i>';
                    }
                    
                    return `
                        <div class="signal-card ${isExpired ? '' : 'new'}">
                            ${resultBadge}
                            <div class="signal-header">
                                <div class="asset">${signal.asset} ${signal.isFree ? '<span class="vip-badge">GRATIS</span>' : ''}</div>
                                <div class="direction ${signal.direction}">
                                    <span class="arrow ${signal.direction}">${signal.direction === 'up' ? '‚Üë' : '‚Üì'}</span>
                                    <span>${signal.direction === 'up' ? 'ALZA' : 'BAJA'}</span>
                                </div>
                            </div>
                            <div class="signal-details">
                                <div class="detail-item">
                                    <span class="detail-label">Duraci√≥n</span>
                                    <span class="detail-value">${signal.timeframe} minuto${signal.timeframe > 1 ? 's' : ''}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Expira</span>
                                    <span class="detail-value">${expiresDate.toLocaleTimeString()}</span>
                                </div>
                            </div>
                            ${!isExpired ? `
                                <div class="time-remaining">
                                    <i class="fas fa-clock"></i> Tiempo restante: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}
                                </div>
                            ` : ''}
                            <div class="signal-status">
                                <div class="status-badge ${statusClass}">
                                    ${statusIcon} ${statusText}
                                </div>
                                ${this.isAdmin && isExpired && signal.status === 'pending' ? `
                                    <div class="admin-controls">
                                        <button class="admin-btn btn-profit" onclick="signalManager.updateOperationStatus(${signal.id}, 'profit')">
                                            <i class="fas fa-check"></i> Ganada
                                        </button>
                                        <button class="admin-btn btn-loss" onclick="signalManager.updateOperationStatus(${signal.id}, 'loss')">
                                            <i class="fas fa-times"></i> Perdida
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                setTimeout(() => {
                    const newCards = document.querySelectorAll('.signal-card.new');
                    newCards.forEach(card => {
                        card.classList.remove('new');
                    });
                }, 1500);
            }
            
            showNotification(message, type = 'info') {
                this.notification.textContent = message;
                
                if (type === 'success') {
                    this.notification.style.background = 'var(--profit)';
                } else if (type === 'error') {
                    this.notification.style.background = 'var(--loss)';
                } else if (type === 'vip') {
                    this.notification.style.background = 'var(--vip)';
                } else {
                    this.notification.style.background = 'var(--primary)';
                }
                
                this.notification.classList.add('show');
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 3000);
            }
            
            showAlert(signal) {
                document.getElementById('alertAsset').textContent = signal.asset;
                
                const alertDirection = document.getElementById('alertDirection');
                alertDirection.className = `direction ${signal.direction}`;
                alertDirection.innerHTML = `
                    <span class="arrow ${signal.direction}">${signal.direction === 'up' ? '‚Üë' : '‚Üì'}</span>
                    <span>${signal.direction === 'up' ? 'ALZA (CALL)' : 'BAJA (PUT)'}</span>
                `;
                
                const expiresDate = new Date(signal.expires);
                const timeRemaining = Math.max(0, Math.floor((expiresDate - new Date()) / 1000));
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('alertTime').textContent = `Expira en: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                this.signalAlert.classList.add('show');
            }
            
            hideAlert() {
                this.signalAlert.classList.remove('show');
            }
            
            showSignalsView() {
                this.statsContainer.classList.remove('active');
                this.usersContainer.classList.remove('active');
                this.showSignals.classList.add('active');
                this.showStats.classList.remove('active');
                this.showUsers.classList.remove('active');
            }
            
            showStatsView() {
                this.statsContainer.classList.add('active');
                this.usersContainer.classList.remove('active');
                this.showSignals.classList.remove('active');
                this.showStats.classList.add('active');
                this.showUsers.classList.remove('active');
                this.updateStats();
            }
            
            showUsersView() {
                this.statsContainer.classList.remove('active');
                this.usersContainer.classList.add('active');
                this.showSignals.classList.remove('active');
                this.showStats.classList.remove('active');
                this.showUsers.classList.add('active');
            }
            
            updateStats(period = 'day') {
                const now = new Date();
                let filteredOperations = [];
                
                if (period === 'day') {
                    filteredOperations = this.operations.filter(op => {
                        const opDate = new Date(op.timestamp);
                        return opDate.toDateString() === now.toDateString();
                    });
                } else if (period === 'week') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    filteredOperations = this.operations.filter(op => {
                        const opDate = new Date(op.timestamp);
                        return opDate >= startOfWeek;
                    });
                } else if (period === 'month') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    filteredOperations = this.operations.filter(op => {
                        const opDate = new Date(op.timestamp);
                        return opDate >= startOfMonth;
                    });
                }
                
                const winOperations = filteredOperations.filter(op => op.status === 'profit');
                const lossOperations = filteredOperations.filter(op => op.status === 'loss');
                const totalOperations = filteredOperations.length;
                
                const winCount = winOperations.length;
                const lossCount = lossOperations.length;
                
                this.winCount.textContent = winCount;
                this.lossCount.textContent = lossCount;
                this.totalCount.textContent = totalOperations;
                
                this.operationsTable.innerHTML = filteredOperations.map(op => {
                    let statusClass = 'status-pending';
                    let statusText = 'PENDIENTE';
                    let statusIcon = '<i class="fas fa-clock"></i>';
                    
                    if (op.status === 'profit') {
                        statusClass = 'status-profit';
                        statusText = 'GANADA';
                        statusIcon = '<i class="fas fa-check-circle"></i>';
                    } else if (op.status === 'loss') {
                        statusClass = 'status-loss';
                        statusText = 'PERDIDA';
                        statusIcon = '<i class="fas fa-times-circle"></i>';
                    }
                    
                    return `
                        <tr>
                            <td>${op.asset}</td>
                            <td>
                                <span class="direction ${op.direction}">
                                    ${op.direction === 'up' ? 'ALZA' : 'BAJA'}
                                </span>
                            </td>
                            <td>${op.timeframe} min</td>
                            <td><span class="status-badge ${statusClass}">${statusIcon} ${statusText}</span></td>
                            <td>${new Date(op.timestamp).toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
                
                this.updateChart(winCount, lossCount, totalOperations);
            }
            
            initChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                this.performanceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ganadas', 'Perdidas', 'Pendientes'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(0, 255, 157, 0.8)',
                                'rgba(255, 0, 51, 0.8)',
                                'rgba(255, 204, 0, 0.8)'
                            ],
                            borderColor: [
                                'rgba(0, 255, 157, 1)',
                                'rgba(255, 0, 51, 1)',
                                'rgba(255, 204, 0, 1)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'white',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribuci√≥n de Operaciones',
                                color: 'white',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }
            
            updateChart(winCount, lossCount, totalCount) {
                const pendingCount = totalCount - winCount - lossCount;
                
                this.performanceChart.data.datasets[0].data = [winCount, lossCount, pendingCount];
                this.performanceChart.update();
            }
            
            saveToLocalStorage() {
                const data = {
                    sessions: this.sessions,
                    currentSession: this.currentSession,
                    isVIP: this.isVIP,
                    hasReceivedFreeSignal: this.hasReceivedFreeSignal
                };
                localStorage.setItem('quantumTraderData', JSON.stringify(data));
            }
            
            loadFromLocalStorage() {
                const data = JSON.parse(localStorage.getItem('quantumTraderData'));
                if (data) {
                    this.sessions = data.sessions || [];
                    this.currentSession = data.currentSession || null;
                    this.isVIP = data.isVIP !== undefined ? data.isVIP : false;
                    this.hasReceivedFreeSignal = data.hasReceivedFreeSignal || false;
                    
                    if (this.currentSession) {
                        this.currentSession.startTime = new Date(this.currentSession.startTime);
                        if (this.currentSession.endTime) {
                            this.currentSession.endTime = new Date(this.currentSession.endTime);
                        }
                    }
                    
                    if (this.currentSession) {
                        this.startSession.disabled = true;
                        this.endSession.disabled = false;
                        this.sessionInfo.innerHTML = `
                            <i class="fas fa-play-circle"></i> Sesi√≥n activa - Iniciada: ${this.currentSession.startTime.toLocaleTimeString()}
                        `;
                        this.sessionInfo.classList.add('session-active');
                    }
                    
                    this.updateUserStatus();
                }
            }
        }

        // =============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // =============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ [APP] DOM cargado - Iniciando aplicaci√≥n');
            createParticles();
            
            // Inicializar SignalManager con el User ID ya detectado
            signalManager = new SignalManager();
            
            setInterval(() => {
                if (signalManager) {
                    signalManager.renderSignals();
                    
                    const alert = document.getElementById('signalAlert');
                    if (alert.classList.contains('show')) {
                        const activeSignal = signalManager.signals[0];
                        if (activeSignal) {
                            const expiresDate = new Date(activeSignal.expires);
                            const timeRemaining = Math.max(0, Math.floor((expiresDate - new Date()) / 1000));
                            const minutes = Math.floor(timeRemaining / 60);
                            const seconds = timeRemaining % 60;
                            document.getElementById('alertTime').textContent = `Expira en: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        }
                    }
                }
            }, 1000);
        });

        // =============================================
        // SCRIPT DE DEBUG MEJORADO
        // =============================================
        
        console.log('=== üêõ DEBUG SCRIPT INICIADO ===');
        console.log('URL completa:', window.location.href);
        console.log('Par√°metros URL:', Object.fromEntries(new URLSearchParams(window.location.search)));
        console.log('Fragmento URL:', window.location.hash);
        console.log('User ID detectado:', detectedUserId);

        // Probar la API despu√©s de 2 segundos
        setTimeout(async () => {
            if (detectedUserId) {
                console.log('üîç TEST: Probando API con userId:', detectedUserId);
                try {
                    const response = await fetch(`/api/user/${detectedUserId}`);
                    const result = await response.json();
                    console.log('üîç TEST: Respuesta API:', result);
                } catch (error) {
                    console.error('üîç TEST: Error API:', error);
                }
            } else {
                console.log('‚ùå TEST: No se pudo obtener userId para testing');
            }
        }, 2000);
    </script>
</body>
</html>
