<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Detecci√≥n de ID</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-top: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .info-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #00ff9d;
        }
        .debug-info {
            background: rgba(255, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid red;
        }
        .success {
            background: rgba(0, 255, 157, 0.2);
            border-left: 4px solid #00ff9d;
        }
        .warning {
            background: rgba(255, 204, 0, 0.2);
            border-left: 4px solid #ffcc00;
        }
        .error {
            background: rgba(255, 0, 51, 0.2);
            border-left: 4px solid #ff0033;
        }
        .method {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .method-name {
            font-weight: bold;
        }
        .method-result {
            color: #00ff9d;
        }
        .method-fail {
            color: #ff0033;
        }
    </style>
</head>
<body>
    <h1>üîç PRUEBA DE DETECCI√ìN DE ID DE TELEGRAM</h1>
    
    <div class="container">
        <div class="info-box success">
            <h2>üéØ RESULTADO FINAL</h2>
            <div id="finalResult" style="font-size: 24px; font-weight: bold; text-align: center;">
                Cargando...
            </div>
        </div>

        <div class="info-box">
            <h2>üìä M√âTODOS DE DETECCI√ìN</h2>
            <div id="methodsResults">
                <!-- Los m√©todos se mostrar√°n aqu√≠ -->
            </div>
        </div>

        <div class="info-box">
            <h2>üîß INFORMACI√ìN T√âCNICA</h2>
            <div class="debug-info">
                <div><strong>URL Completa:</strong> <span id="fullUrl"></span></div>
                <div><strong>User Agent:</strong> <span id="userAgent"></span></div>
                <div><strong>Plataforma:</strong> <span id="platform"></span></div>
            </div>
        </div>

        <div class="info-box">
            <h2>üìù DATOS DE TELEGRAM WEB APP</h2>
            <div class="debug-info" id="telegramData">
                Cargando datos de Telegram...
            </div>
        </div>

        <div class="info-box warning">
            <h2>‚ö†Ô∏è SOLUCI√ìN DE PROBLEMAS</h2>
            <p>Si no se detecta tu ID correctamente:</p>
            <ul>
                <li>Aseg√∫rate de acceder desde la app de Telegram</li>
                <li>Verifica que el bot est√© configurado correctamente</li>
                <li>Comprueba que la URL incluya los par√°metros correctos</li>
            </ul>
        </div>
    </div>

    <script>
        // Mostrar informaci√≥n t√©cnica inmediatamente
        document.getElementById('fullUrl').textContent = window.location.href;
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('platform').textContent = navigator.platform;

        // Funci√≥n mejorada de detecci√≥n de ID
        function testAllMethods() {
            const methods = [];
            let finalUserId = null;

            // M√âTODO 1: Par√°metro tgid en URL
            const urlParams = new URLSearchParams(window.location.search);
            const tgId = urlParams.get('tgid');
            methods.push({
                name: '1. Par√°metro tgid en URL',
                result: tgId,
                success: !!tgId
            });
            if (tgId) finalUserId = tgId;

            // M√âTODO 2: Telegram WebApp SDK
            let sdkResult = 'NO';
            let sdkSuccess = false;
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand(); // Expandir la WebApp
                
                const user = tg.initDataUnsafe?.user;
                if (user && user.id) {
                    sdkResult = user.id.toString();
                    sdkSuccess = true;
                    if (!finalUserId) finalUserId = sdkResult;
                } else {
                    sdkResult = 'SDK disponible pero sin user.id';
                }
                
                // Mostrar datos completos del SDK
                document.getElementById('telegramData').innerHTML = `
                    <strong>initDataUnsafe:</strong><br>
                    <pre>${JSON.stringify(tg.initDataUnsafe, null, 2)}</pre><br>
                    <strong>User:</strong><br>
                    <pre>${JSON.stringify(user, null, 2)}</pre>
                `;
            } else {
                sdkResult = 'SDK de Telegram no disponible';
            }
            methods.push({
                name: '2. Telegram WebApp SDK',
                result: sdkResult,
                success: sdkSuccess
            });

            // M√âTODO 3: Fragmento URL (tgWebAppData)
            try {
                const fragment = window.location.hash.substring(1);
                let fragmentResult = 'NO';
                let fragmentSuccess = false;
                
                if (fragment) {
                    const fragmentParams = new URLSearchParams(fragment);
                    const tgWebAppData = fragmentParams.get('tgWebAppData');
                    
                    if (tgWebAppData) {
                        const decodedWebAppData = decodeURIComponent(tgWebAppData);
                        const webAppParams = new URLSearchParams(decodedWebAppData);
                        const userString = webAppParams.get('user');
                        
                        if (userString) {
                            const userData = JSON.parse(decodeURIComponent(userString));
                            if (userData && userData.id) {
                                fragmentResult = userData.id.toString();
                                fragmentSuccess = true;
                                if (!finalUserId) finalUserId = fragmentResult;
                            }
                        } else {
                            fragmentResult = 'Fragmento sin user data';
                        }
                    } else {
                        fragmentResult = 'Fragmento sin tgWebAppData';
                    }
                } else {
                    fragmentResult = 'Sin fragmento en URL';
                }
                
                methods.push({
                    name: '3. Fragmento de URL',
                    result: fragmentResult,
                    success: fragmentSuccess
                });
            } catch (error) {
                methods.push({
                    name: '3. Fragmento de URL',
                    result: 'Error: ' + error.message,
                    success: false
                });
            }

            // M√âTODO 4: localStorage
            const storedId = localStorage.getItem('tg_user_id');
            methods.push({
                name: '4. localStorage',
                result: storedId || 'NO',
                success: !!storedId
            });
            if (storedId && !finalUserId) finalUserId = storedId;

            // M√âTODO 5: Guest ID (fallback)
            if (!finalUserId) {
                const guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                finalUserId = guestId;
                methods.push({
                    name: '5. Guest ID (fallback)',
                    result: guestId,
                    success: false
                });
            } else {
                methods.push({
                    name: '5. Guest ID (fallback)',
                    result: 'No necesario - ID ya detectado',
                    success: true
                });
            }

            // Guardar en localStorage si es un ID real
            if (finalUserId && !finalUserId.startsWith('guest_')) {
                localStorage.setItem('tg_user_id', finalUserId);
            }

            return { methods, finalUserId };
        }

        // Ejecutar la prueba y mostrar resultados
        function runTest() {
            const { methods, finalUserId } = testAllMethods();
            
            // Mostrar m√©todos
            const methodsContainer = document.getElementById('methodsResults');
            methodsContainer.innerHTML = methods.map(method => `
                <div class="method">
                    <span class="method-name">${method.name}</span>
                    <span class="${method.success ? 'method-result' : 'method-fail'}">
                        ${method.result}
                    </span>
                </div>
            `).join('');

            // Mostrar resultado final
            const finalResult = document.getElementById('finalResult');
            finalResult.textContent = `ID Detectado: ${finalUserId}`;
            
            if (finalUserId.startsWith('guest_')) {
                finalResult.style.color = '#ff0033';
                finalResult.innerHTML += '<br><span style="font-size: 16px; color: #ffcc00;">‚ö†Ô∏è Solo ID de guest - No se detect√≥ ID real de Telegram</span>';
            } else {
                finalResult.style.color = '#00ff9d';
                finalResult.innerHTML += '<br><span style="font-size: 16px; color: #00ff9d;">‚úÖ ID real detectado correctamente</span>';
            }

            // Mostrar en consola tambi√©n
            console.log('=== üîç PRUEBA DE DETECCI√ìN DE ID ===');
            console.log('ID Final:', finalUserId);
            console.log('M√©todos:', methods);
            console.log('URL Completa:', window.location.href);
            console.log('User Agent:', navigator.userAgent);
        }

        // Ejecutar cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', runTest);

        // Tambi√©n ejecutar despu√©s de un tiempo por si el SDK se carga despu√©s
        setTimeout(runTest, 1000);
        setTimeout(runTest, 3000);
    </script>
</body>
</html>
