<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Signal Trader</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ff9d;
            --secondary: #00e5ff;
            --accent: #ff00e5;
            --vip: #ffcc00;
            --profit: #00ff9d;
            --loss: #ff0033;
            --warning: #ffcc00;
            --dark: #0a0a0a;
            --darker: #050505;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #888;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .user-badge {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-badge.admin {
            background: linear-gradient(45deg, var(--primary), #00cc7d);
            color: var(--dark);
        }

        .user-badge.vip {
            background: linear-gradient(45deg, var(--vip), #ffaa00);
            color: var(--dark);
        }

        .user-badge.regular {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: var(--dark);
            font-weight: bold;
        }

        .panel {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .signal-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 0.9em;
            color: #ccc;
        }

        .form-control {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: var(--dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 157, 0.4);
        }

        .btn-vip {
            background: linear-gradient(45deg, var(--vip), #ffaa00);
            color: var(--dark);
        }

        .btn-vip:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 204, 0, 0.4);
        }

        .btn-admin {
            background: linear-gradient(45deg, var(--primary), #00cc7d);
            color: var(--dark);
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 157, 0.4);
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .signal-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .signal-card.new {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 157, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 157, 0); }
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .asset {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--primary);
        }

        .direction {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .direction.up {
            background: rgba(0, 255, 157, 0.2);
            color: var(--profit);
            border: 1px solid var(--profit);
        }

        .direction.down {
            background: rgba(255, 0, 51, 0.2);
            color: var(--loss);
            border: 1px solid var(--loss);
        }

        .signal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-label {
            color: #ccc;
            font-size: 0.9em;
        }

        .detail-value {
            font-weight: bold;
            color: white;
        }

        .time-remaining {
            background: rgba(255, 204, 0, 0.1);
            color: var(--warning);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }

        .signal-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-pending {
            background: rgba(255, 204, 0, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-profit {
            background: rgba(0, 255, 157, 0.2);
            color: var(--profit);
            border: 1px solid var(--profit);
        }

        .status-loss {
            background: rgba(255, 0, 51, 0.2);
            color: var(--loss);
            border: 1px solid var(--loss);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--card-border);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-profit .stat-value {
            color: var(--profit);
        }

        .stat-loss .stat-value {
            color: var(--loss);
        }

        .stat-total .stat-value {
            color: var(--primary);
        }

        .time-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .time-filter {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-filter.active {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary);
        }

        .operations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .operations-table th,
        .operations-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .operations-table th {
            color: #ccc;
            font-weight: normal;
            font-size: 0.9em;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid var(--card-border);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--card-border);
            text-align: center;
        }

        .admin-card h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }

        .user-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-search input {
            flex: 1;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            margin: 2px;
        }

        .btn-profit {
            background: var(--profit);
            color: var(--dark);
        }

        .btn-loss {
            background: var(--loss);
            color: white;
        }

        .btn-notify {
            background: var(--warning);
            color: var(--dark);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .signal-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            z-index: 2000;
            text-align: center;
            min-width: 300px;
            backdrop-filter: blur(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .signal-alert.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        .status-connected {
            background: var(--profit);
        }

        .status-disconnected {
            background: var(--loss);
        }

        @keyframes pulse-dot {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .signal-form {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .admin-controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="particles"></div>

    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>

    <!-- Alerta de Se√±al -->
    <div id="signalAlert" class="signal-alert">
        <div class="asset" id="alertAsset">EUR/USD</div>
        <div class="direction" id="alertDirection">
            <span class="arrow">‚Üë</span>
            <span>ALZA</span>
        </div>
        <div class="time-remaining" id="alertTime">Expira en: 05:00</div>
        <button id="closeAlert" class="btn btn-primary" style="margin-top: 20px;">
            <i class="fas fa-check"></i> ENTENDIDO
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-satellite-dish"></i> QUANTUM TRADER
            </div>
            <div class="subtitle">Sistema de Se√±ales de Trading en Tiempo Real</div>
            
            <div class="user-info">
                <div id="userIdDisplay" class="user-badge regular">
                    <i class="fas fa-user"></i> ID: Cargando...
                </div>
                <div id="userStatus" class="session-info">
                    <i class="fas fa-user"></i> Estado: Cargando...
                </div>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="nav-tabs">
            <button id="showSignals" class="nav-btn active">
                <i class="fas fa-chart-line"></i> Se√±ales
            </button>
            <button id="showStats" class="nav-btn">
                <i class="fas fa-chart-bar"></i> Estad√≠sticas
            </button>
            <button id="showUsers" class="nav-btn" style="display: none;">
                <i class="fas fa-users"></i> Usuarios
            </button>
            <button id="vipAccess" class="nav-btn">
                <i class="fas fa-crown"></i> VIP
            </button>
            <button id="adminBtn" class="nav-btn" style="display: none;">
                <i class="fas fa-user-shield"></i> Panel Admin
            </button>
            <button id="readyBtn" class="nav-btn">
                <i class="fas fa-bell"></i> PREPARADOS
            </button>
        </div>

        <!-- Panel de Se√±ales -->
        <div id="signalsPanel" class="panel active">
            <div class="signal-form">
                <div class="form-group">
                    <label for="asset"><i class="fas fa-coins"></i> Activo</label>
                    <input type="text" id="asset" class="form-control" placeholder="Ej: EURUSD, BTCUSD">
                </div>
                <div class="form-group">
                    <label for="timeframe"><i class="fas fa-clock"></i> Timeframe (min)</label>
                    <select id="timeframe" class="form-control">
                        <option value="1">1 minuto</option>
                        <option value="3">3 minutos</option>
                        <option value="5" selected>5 minutos</option>
                        <option value="15">15 minutos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="direction"><i class="fas fa-arrows-alt-v"></i> Direcci√≥n</label>
                    <select id="direction" class="form-control">
                        <option value="up">ALZA (CALL)</option>
                        <option value="down">BAJA (PUT)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="sendSignal" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> ENVIAR SE√ëAL
                    </button>
                </div>
            </div>

            <div id="signalsContainer">
                <div class="empty-state">
                    <i class="fas fa-satellite-dish"></i>
                    <p>Esperando se√±ales de trading...</p>
                    <p>Las se√±ales aparecer√°n aqu√≠ autom√°ticamente</p>
                </div>
            </div>
        </div>

        <!-- Panel de Estad√≠sticas -->
        <div id="statsContainer" class="panel">
            <div class="stats-cards">
                <div class="stat-card stat-profit">
                    <i class="fas fa-check-circle"></i>
                    <div class="stat-label">Operaciones Ganadas</div>
                    <div class="stat-value" id="winCount">0</div>
                </div>
                <div class="stat-card stat-loss">
                    <i class="fas fa-times-circle"></i>
                    <div class="stat-label">Operaciones Perdidas</div>
                    <div class="stat-value" id="lossCount">0</div>
                </div>
                <div class="stat-card stat-total">
                    <i class="fas fa-chart-line"></i>
                    <div class="stat-label">Total Operaciones</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
            </div>

            <div class="time-filters">
                <button class="time-filter active" data-period="day">Hoy</button>
                <button class="time-filter" data-period="week">Esta Semana</button>
                <button class="time-filter" data-period="month">Este Mes</button>
            </div>

            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>

            <table class="operations-table">
                <thead>
                    <tr>
                        <th>Activo</th>
                        <th>Direcci√≥n</th>
                        <th>Duraci√≥n</th>
                        <th>Estado</th>
                        <th>Fecha/Hora</th>
                    </tr>
                </thead>
                <tbody id="operationsTable">
                    <!-- Las operaciones se cargar√°n aqu√≠ -->
                </tbody>
            </table>
        </div>

        <!-- Panel de Usuarios (Admin) -->
        <div id="usersContainer" class="panel">
            <div class="admin-card">
                <h3><i class="fas fa-search"></i> Buscar Usuario</h3>
                <div class="user-search">
                    <input type="text" id="userSearchInput" class="form-control" placeholder="ID de Telegram">
                    <button id="searchUserBtn" class="btn btn-primary">Buscar</button>
                </div>
                <div id="userSearchResult" style="display: none; margin-top: 15px;"></div>
                <div id="userActions" style="display: none; gap: 10px; margin-top: 15px; justify-content: center;">
                    <button id="makeVipBtn" class="btn btn-vip">Hacer VIP</button>
                    <button id="removeVipBtn" class="btn btn-loss">Quitar VIP</button>
                </div>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-users"></i> Todos los Usuarios</h3>
                <button id="refreshUsers" class="btn btn-primary" style="margin-bottom: 15px;">
                    <i class="fas fa-sync"></i> Actualizar Lista
                </button>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID Telegram</th>
                            <th>Usuario</th>
                            <th>Estado VIP</th>
                            <th>Expiraci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Los usuarios se cargar√°n aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel de Control de Sesi√≥n -->
        <div class="panel">
            <div class="admin-controls">
                <div class="admin-card">
                    <h3><i class="fas fa-play-circle"></i> Control de Sesi√≥n</h3>
                    <div id="sessionInfo" class="session-info">
                        <i class="fas fa-stop-circle"></i> Sesi√≥n no iniciada
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
                        <button id="startSession" class="btn btn-primary">Iniciar Sesi√≥n</button>
                        <button id="endSession" class="btn btn-loss" disabled>Finalizar Sesi√≥n</button>
                    </div>
                </div>

                <div class="admin-card">
                    <h3><i class="fas fa-bell"></i> Notificaciones</h3>
                    <p style="margin-bottom: 15px; color: #ccc;">Notificar a todos los usuarios</p>
                    <button id="notifyClients" class="btn btn-vip">
                        <i class="fas fa-broadcast-tower"></i> Notificar en 10 min
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal VIP -->
        <div id="vipModal" class="panel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; max-width: 500px; width: 90%;">
            <div class="admin-card">
                <h3><i class="fas fa-crown"></i> Acceso VIP</h3>
                <p style="margin-bottom: 20px; color: #ccc;">
                    El acceso VIP te permite recibir todas las se√±ales de trading en tiempo real.
                    Contacta con el administrador para obtener acceso VIP.
                </p>
                <button id="closeVipModal" class="btn btn-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Estado de Conexi√≥n -->
    <div id="connectionStatus" class="connection-status">
        <div class="status-dot status-connected" id="statusDot"></div>
        <span id="statusText">Conectado al servidor</span>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN GLOBAL Y DETECCI√ìN DE USUARIO
        // =============================================

        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://flodrkrvaqsmelbkfknv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZsb2Rya3J2YXFzbWVsYmtma252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwODY0NjgsImV4cCI6MjA3OTY2MjQ2OH0.zVTaUbkiLCJ0dUFs808TZErgnIXCYsYQ2lw-CEmVCFI';

        // Inicializar cliente de Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // URL del servidor (mismo dominio)
        const SERVER_URL = window.location.origin;

        // ID del administrador
        const ADMIN_ID = "5376388604";

        // Variable global para el manager
        let signalManager = null;

        // =============================================
        // FUNCI√ìN PRINCIPAL DE DETECCI√ìN DE USER ID
        // =============================================

        function getUserIdSuperRobust() {
            console.log('üîç [USER_ID] Iniciando detecci√≥n de User ID');
            
            // 1. PRIMERA PRIORIDAD: tgid de la URL (m√°s confiable)
            const urlParams = new URLSearchParams(window.location.search);
            const tgId = urlParams.get('tgid');
            if (tgId) {
                console.log('üéØ [USER_ID] ID obtenido desde tgid URL:', tgId);
                return tgId;
            }
            
            // 2. SEGUNDA OPCI√ìN: Telegram Web App SDK
            if (window.Telegram && window.Telegram.WebApp) {
                console.log('üîß [TELEGRAM] Telegram Web App SDK detectado');
                const tg = window.Telegram.WebApp;
                tg.expand();
                
                const user = tg.initDataUnsafe?.user;
                if (user && user.id) {
                    console.log('üéØ [USER_ID] ID obtenido desde SDK:', user.id);
                    return user.id.toString();
                }
            }
            
            // 3. TERCERA OPCI√ìN: Fragmento de URL (tgWebAppData)
            try {
                const fragment = window.location.hash.substring(1);
                if (fragment) {
                    const fragmentParams = new URLSearchParams(fragment);
                    const tgWebAppData = fragmentParams.get('tgWebAppData');
                    
                    if (tgWebAppData) {
                        console.log('üîç [TELEGRAM] Procesando tgWebAppData del fragmento');
                        const decodedWebAppData = decodeURIComponent(tgWebAppData);
                        const webAppParams = new URLSearchParams(decodedWebAppData);
                        const userString = webAppParams.get('user');
                        
                        if (userString) {
                            const userData = JSON.parse(decodeURIComponent(userString));
                            if (userData && userData.id) {
                                console.log('üéØ [USER_ID] ID obtenido desde fragmento:', userData.id);
                                return userData.id.toString();
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå [TELEGRAM] Error parseando fragmento:', error);
            }
            
            // 4. CUARTA OPCI√ìN: localStorage
            const storedId = localStorage.getItem('tg_user_id');
            if (storedId) {
                console.log('üéØ [USER_ID] ID obtenido desde localStorage:', storedId);
                return storedId;
            }
            
            // 5. √öLTIMO RECURSO: Generar guest ID
            const guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
            console.log('‚ö†Ô∏è [USER_ID] Generando ID de guest:', guestId);
            return guestId;
        }

        // =============================================
        // INICIALIZACI√ìN INMEDIATA DEL USER ID
        // =============================================

        // Detectar User ID inmediatamente al cargar la p√°gina
        const detectedUserId = getUserIdSuperRobust();
        console.log('üöÄ [APP] User ID detectado al inicio:', detectedUserId);

        // Guardar en localStorage inmediatamente
        if (detectedUserId && !detectedUserId.startsWith('guest_')) {
            localStorage.setItem('tg_user_id', detectedUserId);
            console.log('üíæ [APP] User ID guardado en localStorage');
        }

        // =============================================
        // SISTEMA DE PART√çCULAS
        // =============================================

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const left = Math.random() * 100;
                const delay = Math.random() * 15;
                const duration = 15 + Math.random() * 10;
                
                particle.style.left = `${left}%`;
                particle.style.animationDelay = `${delay}s`;
                particle.style.animationDuration = `${duration}s`;
                
                const size = 2 + Math.random() * 3;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                const colors = ['var(--primary)', 'var(--secondary)', 'var(--accent)'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                particle.style.background = color;
                
                particlesContainer.appendChild(particle);
            }
        }

        // =============================================
        // CLASE PRINCIPAL SIGNAL MANAGER
        // =============================================

        class SignalManager {
            constructor() {
                this.signals = [];
                this.operations = [];
                this.sessions = [];
                this.currentSession = null;
                this.isAdmin = false;
                this.isVIP = false;
                this.hasReceivedFreeSignal = false;
                this.serverConnected = false;
                
                // Usar el User ID ya detectado globalmente
                this.currentUserId = detectedUserId;
                this.userData = null;
                this.searchedUser = null;
                
                console.log('üöÄ [APP] Inicializando SignalManager con User ID:', this.currentUserId);
                
                // Inicializaci√≥n inmediata
                this.initializeDOMElements();
                this.initEventListeners();
                this.loadFromLocalStorage();
                this.updateStats();
                this.initChart();
                
                // Cargar datos del usuario
                this.loadUserData();
                this.setupRealtimeSubscription();
                this.checkServerConnection();
                
                setInterval(() => this.checkServerConnection(), 30000);
                
                // Actualizar UI inmediatamente
                this.updateUI();
            }
            
            async loadUserData() {
                if (!this.currentUserId || this.currentUserId.startsWith('guest_')) {
                    console.log('‚ùå [APP] No hay User ID v√°lido para cargar datos');
                    this.updateUserStatus();
                    return;
                }
                
                try {
                    console.log('üîç [APP] Cargando datos del usuario desde servidor:', this.currentUserId);
                    const apiUrl = `${SERVER_URL}/api/user/${this.currentUserId}`;
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.userData = result.data;
                        
                        console.log('üîç [APP] Datos completos del servidor:', result.data);
                        
                        // DETECCI√ìN ROBUSTA DE ADMIN - CON LOGS DETALLADOS
                        const userIdStr = String(this.currentUserId).trim();
                        const adminIdStr = String(ADMIN_ID).trim();
                        
                        console.log('üéØ [ADMIN] Comparando:');
                        console.log('üéØ [ADMIN] User ID:', userIdStr);
                        console.log('üéØ [ADMIN] ADMIN_ID:', adminIdStr);
                        console.log('üéØ [ADMIN] ¬øCoinciden?:', userIdStr === adminIdStr);
                        console.log('üéØ [ADMIN] is_admin desde servidor:', result.data.is_admin);
                        
                        // PRIORIDAD: Datos del servidor, luego detecci√≥n local
                        this.isAdmin = result.data.is_admin || (userIdStr === adminIdStr);
                        this.isVIP = result.data.is_vip || false;
                        
                        console.log('‚úÖ [APP] Estados finales - Admin:', this.isAdmin, 'VIP:', this.isVIP);
                        
                        // Verificar si el VIP ha expirado
                        if (this.isVIP && this.userData.vip_expires_at) {
                            const expiryDate = new Date(this.userData.vip_expires_at);
                            const now = new Date();
                            console.log('üìÖ [VIP] Fecha de expiraci√≥n:', expiryDate);
                            console.log('üìÖ [VIP] Fecha actual:', now);
                            console.log('üìÖ [VIP] ¬øHa expirado?:', expiryDate < now);
                            
                            if (expiryDate < now) {
                                this.isVIP = false;
                                console.log('‚ö†Ô∏è [APP] VIP expirado');
                            }
                        }
                        
                        // Si es admin, asegurarse de que tambi√©n sea VIP
                        if (this.isAdmin && !this.isVIP) {
                            console.log('üîÑ [APP] Admin detectado - Activando VIP autom√°ticamente');
                            this.isVIP = true;
                        }
                    } else {
                        console.error('‚ùå [APP] Error en respuesta del servidor:', result);
                        
                        // Fallback: detecci√≥n local si el servidor falla
                        const userIdStr = String(this.currentUserId).trim();
                        const adminIdStr = String(ADMIN_ID).trim();
                        this.isAdmin = (userIdStr === adminIdStr);
                        this.isVIP = this.isAdmin; // Admin siempre es VIP
                        console.log('üîÑ [APP] Usando detecci√≥n local - Admin:', this.isAdmin, 'VIP:', this.isVIP);
                    }
                } catch (error) {
                    console.error('‚ùå [APP] Error cargando datos del usuario:', error);
                    
                    // Fallback en caso de error
                    const userIdStr = String(this.currentUserId).trim();
                    const adminIdStr = String(ADMIN_ID).trim();
                    this.isAdmin = (userIdStr === adminIdStr);
                    this.isVIP = this.isAdmin;
                    console.log('üîÑ [APP] Fallback por error - Admin:', this.isAdmin, 'VIP:', this.isVIP);
                } finally {
                    this.updateUI();
                }
            }
            
            updateUI() {
                console.log('üîÑ [APP] Actualizando UI con UserID:', this.currentUserId, 'Admin:', this.isAdmin, 'VIP:', this.isVIP);
                
                // Mostrar el ID del usuario inmediatamente
                const userIdDisplay = document.getElementById('userIdDisplay');
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID: ${this.currentUserId}`;
                    userIdDisplay.className = 'user-badge ';
                    if (this.isAdmin) {
                        userIdDisplay.classList.add('admin');
                        userIdDisplay.innerHTML = `<i class="fas fa-user-shield"></i> ID: ${this.currentUserId} (Admin)`;
                    } else if (this.isVIP) {
                        userIdDisplay.classList.add('vip');
                        userIdDisplay.innerHTML = `<i class="fas fa-crown"></i> ID: ${this.currentUserId} (VIP)`;
                    } else {
                        userIdDisplay.classList.add('regular');
                        userIdDisplay.innerHTML = `<i class="fas fa-user"></i> ID: ${this.currentUserId}`;
                    }
                }

                // Actualizar estado del usuario
                this.updateUserStatus();
                
                // Mostrar/ocultar panel de admin
                if (this.isAdmin) {
                    this.adminBtn.style.display = 'block';
                    this.adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> Panel Admin';
                    this.adminBtn.classList.add('active');
                    this.adminPanel.style.display = 'block';
                    this.showUsers.style.display = 'block';
                    this.loadUsersFromSupabase();
                } else {
                    this.adminBtn.style.display = 'none';
                    this.adminPanel.style.display = 'none';
                    this.showUsers.style.display = 'none';
                }
                
                // Actualizar estado VIP
                if (this.isVIP) {
                    this.vipAccess.innerHTML = '<i class="fas fa-crown"></i> VIP ACTIVO';
                    this.vipAccess.classList.add('active');
                } else {
                    this.vipAccess.innerHTML = '<i class="fas fa-crown"></i> VIP';
                    this.vipAccess.classList.remove('active');
                }
            }

            initializeDOMElements() {
                console.log('üèóÔ∏è [APP] Inicializando elementos DOM');
                
                this.sendSignalBtn = document.getElementById('sendSignal');
                this.signalsContainer = document.getElementById('signalsContainer');
                this.notification = document.getElementById('notification');
                this.signalAlert = document.getElementById('signalAlert');
                this.readyBtn = document.getElementById('readyBtn');
                this.closeAlert = document.getElementById('closeAlert');
                this.showSignals = document.getElementById('showSignals');
                this.showStats = document.getElementById('showStats');
                this.showUsers = document.getElementById('showUsers');
                this.vipAccess = document.getElementById('vipAccess');
                this.adminBtn = document.getElementById('adminBtn');
                this.statsContainer = document.getElementById('statsContainer');
                this.usersContainer = document.getElementById('usersContainer');
                this.sessionInfo = document.getElementById('sessionInfo');
                this.userStatus = document.getElementById('userStatus');
                this.startSession = document.getElementById('startSession');
                this.endSession = document.getElementById('endSession');
                this.notifyClients = document.getElementById('notifyClients');
                this.vipModal = document.getElementById('vipModal');
                this.closeVipModal = document.getElementById('closeVipModal');
                this.adminPanel = document.getElementById('adminPanel');
                this.usersTableBody = document.getElementById('usersTableBody');
                this.refreshUsers = document.getElementById('refreshUsers');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.statusDot = document.getElementById('statusDot');
                this.statusText = document.getElementById('statusText');
                
                // Elementos para gesti√≥n de usuarios
                this.userSearchInput = document.getElementById('userSearchInput');
                this.searchUserBtn = document.getElementById('searchUserBtn');
                this.userSearchResult = document.getElementById('userSearchResult');
                this.makeVipBtn = document.getElementById('makeVipBtn');
                this.removeVipBtn = document.getElementById('removeVipBtn');
                this.userActions = document.getElementById('userActions');
                
                this.isReady = false;
                
                // Estad√≠sticas
                this.winCount = document.getElementById('winCount');
                this.lossCount = document.getElementById('lossCount');
                this.totalCount = document.getElementById('totalCount');
                this.operationsTable = document.getElementById('operationsTable');
                this.performanceChart = null;
            }
            
            async checkServerConnection() {
                try {
                    const response = await fetch(`${SERVER_URL}/health`);
                    if (response.ok) {
                        this.serverConnected = true;
                        this.updateConnectionStatus(true, 'Conectado al servidor');
                    } else {
                        throw new Error('Server not responding');
                    }
                } catch (error) {
                    this.serverConnected = false;
                    this.updateConnectionStatus(false, 'Error de conexi√≥n con el servidor');
                    console.error('Error checking server connection:', error);
                }
            }
            
            updateConnectionStatus(connected, message) {
                if (connected) {
                    this.statusDot.className = 'status-dot status-connected';
                    this.statusText.textContent = message;
                    this.connectionStatus.style.background = 'rgba(0, 255, 157, 0.1)';
                } else {
                    this.statusDot.className = 'status-dot status-disconnected';
                    this.statusText.textContent = message;
                    this.connectionStatus.style.background = 'rgba(255, 0, 51, 0.1)';
                }
            }
            
            initEventListeners() {
                // Evento para enviar se√±ales
                this.sendSignalBtn.addEventListener('click', () => {
                    this.sendSignal();
                });
                
                this.readyBtn.addEventListener('click', () => {
                    this.toggleReady();
                });
                
                this.closeAlert.addEventListener('click', () => {
                    this.hideAlert();
                });
                
                this.showSignals.addEventListener('click', () => {
                    this.showSignalsView();
                });
                
                this.showStats.addEventListener('click', () => {
                    this.showStatsView();
                });
                
                this.showUsers.addEventListener('click', () => {
                    this.showUsersView();
                });
                
                this.vipAccess.addEventListener('click', () => {
                    this.showVipModal();
                });
                
                this.adminBtn.addEventListener('click', () => {
                    if (this.isAdmin) {
                        this.showAdminPanel();
                    }
                });
                
                this.startSession.addEventListener('click', () => {
                    this.startTradingSession();
                });
                
                this.endSession.addEventListener('click', () => {
                    this.endTradingSession();
                });
                
                this.notifyClients.addEventListener('click', () => {
                    this.sendClientNotification();
                });
                
                this.closeVipModal.addEventListener('click', () => {
                    this.hideVipModal();
                });
                
                this.refreshUsers.addEventListener('click', () => {
                    this.loadUsersFromSupabase();
                });

                // Event listeners para gesti√≥n de usuarios
                this.searchUserBtn.addEventListener('click', () => {
                    this.searchUser();
                });
                
                this.makeVipBtn.addEventListener('click', () => {
                    this.makeUserVip();
                });
                
                this.removeVipBtn.addEventListener('click', () => {
                    this.removeUserVip();
                });
                
                // Filtros de tiempo para estad√≠sticas
                document.querySelectorAll('.time-filter').forEach(filter => {
                    filter.addEventListener('click', () => {
                        document.querySelectorAll('.time-filter').forEach(f => f.classList.remove('active'));
                        filter.classList.add('active');
                        this.updateStats(filter.dataset.period);
                    });
                });
            }

            async searchUser() {
                const searchId = this.userSearchInput.value.trim();
                if (!searchId) {
                    alert('Por favor, ingresa un ID de Telegram');
                    return;
                }

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/search/${searchId}`);
                    const result = await response.json();

                    if (result.success) {
                        this.searchedUser = result.data;
                        this.displayUserSearchResult();
                    } else {
                        this.userSearchResult.innerHTML = '<p class="error">Error al buscar usuario</p>';
                        this.userSearchResult.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error buscando usuario:', error);
                    this.userSearchResult.innerHTML = '<p class="error">Error al buscar usuario</p>';
                    this.userSearchResult.style.display = 'block';
                }
            }

            displayUserSearchResult() {
                if (!this.searchedUser) {
                    this.userSearchResult.innerHTML = `
                        <div class="user-not-found">
                            <i class="fas fa-user-times"></i>
                            <p>Usuario no encontrado</p>
                            <p>El ID ${this.userSearchInput.value} no est√° registrado en el sistema</p>
                        </div>
                    `;
                } else {
                    const isVip = this.searchedUser.is_vip;
                    const vipExpires = this.searchedUser.vip_expires_at ? new Date(this.searchedUser.vip_expires_at) : null;
                    const now = new Date();
                    const daysLeft = vipExpires ? Math.ceil((vipExpires - now) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let vipStatus = 'No VIP';
                    let daysLeftHtml = '';
                    
                    if (isVip && vipExpires && vipExpires > now) {
                        vipStatus = 'Usuario VIP';
                        daysLeftHtml = `<div class="vip-time-remaining">Tiempo restante: <span class="days-left">${daysLeft} d√≠as</span></div>`;
                    } else if (isVip && vipExpires && vipExpires <= now) {
                        vipStatus = 'VIP Expirado';
                    }

                    this.userSearchResult.innerHTML = `
                        <div class="user-found">
                            <div class="user-header">
                                <i class="fas fa-user"></i>
                                <h4>Usuario Encontrado</h4>
                            </div>
                            <div class="user-details">
                                <p><strong>ID:</strong> ${this.searchedUser.telegram_id}</p>
                                <p><strong>Nombre:</strong> ${this.searchedUser.first_name || 'No especificado'}</p>
                                <p><strong>Usuario:</strong> @${this.searchedUser.username || 'No especificado'}</p>
                                <p><strong>Estado:</strong> <span class="user-status ${isVip && vipExpires > now ? 'vip' : 'regular'}">${vipStatus}</span></p>
                                ${daysLeftHtml}
                            </div>
                        </div>
                    `;

                    // Mostrar botones seg√∫n el estado VIP
                    this.userActions.style.display = 'flex';
                    this.makeVipBtn.style.display = (!isVip || (vipExpires && vipExpires <= now)) ? 'block' : 'none';
                    this.removeVipBtn.style.display = (isVip && vipExpires && vipExpires > now) ? 'block' : 'none';
                }

                this.userSearchResult.style.display = 'block';
            }

            async makeUserVip() {
                if (!this.searchedUser) return;

                const days = prompt('¬øPor cu√°ntos d√≠as quieres hacer VIP al usuario?', '30');
                if (!days || isNaN(days)) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: this.searchedUser.telegram_id,
                            userId: this.currentUserId,
                            days: parseInt(days)
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        // Recargar la informaci√≥n del usuario
                        await this.searchUser();
                    } else {
                        this.showNotification('Error al hacer VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error haciendo usuario VIP:', error);
                    this.showNotification('Error al hacer VIP al usuario', 'error');
                }
            }

            async removeUserVip() {
                if (!this.searchedUser) return;

                if (!confirm('¬øEst√°s seguro de que quieres quitar el VIP a este usuario?')) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/remove-vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: this.searchedUser.telegram_id,
                            userId: this.currentUserId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        // Recargar la informaci√≥n del usuario
                        await this.searchUser();
                    } else {
                        this.showNotification('Error al quitar VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error quitando VIP:', error);
                    this.showNotification('Error al quitar VIP al usuario', 'error');
                }
            }
            
            async loadUsersFromSupabase() {
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    if (data) {
                        this.renderUsers(data);
                    }
                } catch (error) {
                    console.error('Error loading users from Supabase:', error);
                }
            }
            
            renderUsers(users) {
                this.usersTableBody.innerHTML = users.map(user => {
                    const isVip = user.is_vip;
                    const vipExpires = user.vip_expires_at ? new Date(user.vip_expires_at) : null;
                    const now = new Date();
                    const expiresIn = vipExpires ? Math.ceil((vipExpires - now) / (1000 * 60 * 60 * 24)) : 0;
                    
                    let vipStatus = 'No VIP';
                    let daysLeftClass = '';
                    
                    if (isVip && vipExpires && vipExpires > now) {
                        vipStatus = `VIP - Expira en <span class="days-left ${expiresIn <= 5 ? 'danger' : (expiresIn <= 15 ? 'warning' : '')}">${expiresIn} d√≠as</span>`;
                    } else if (isVip && vipExpires && vipExpires <= now) {
                        vipStatus = 'VIP Expirado';
                    }
                    
                    return `
                        <tr>
                            <td>${user.telegram_id}</td>
                            <td>${user.username || user.first_name || 'N/A'}</td>
                            <td>${vipStatus}</td>
                            <td>${vipExpires ? vipExpires.toLocaleDateString() : 'N/A'}</td>
                            <td class="user-actions">
                                ${!isVip || (vipExpires && vipExpires <= now) ? 
                                    `<button class="user-action-btn btn-profit" onclick="signalManager.makeVip('${user.telegram_id}')">Hacer VIP</button>` : 
                                    `<button class="user-action-btn btn-loss" onclick="signalManager.removeVip('${user.telegram_id}')">Quitar VIP</button>`
                                }
                                ${isVip && vipExpires && vipExpires > now && expiresIn <= 5 ? 
                                    `<button class="user-action-btn btn-notify" onclick="signalManager.notifyVipExpiring('${user.telegram_id}')">Notificar (5 d√≠as)</button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            async makeVip(telegramId) {
                const days = prompt('¬øPor cu√°ntos d√≠as quieres hacer VIP al usuario?', '30');
                if (!days || isNaN(days)) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: telegramId,
                            userId: this.currentUserId,
                            days: parseInt(days)
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        this.loadUsersFromSupabase();
                    } else {
                        this.showNotification('Error al hacer VIP: ' + result.error, 'error');
                        }
                } catch (error) {
                    console.error('Error haciendo usuario VIP:', error);
                    this.showNotification('Error al hacer VIP al usuario', 'error');
                }
            }
            
            async removeVip(telegramId) {
                if (!confirm('¬øEst√°s seguro de que quieres quitar el VIP a este usuario?')) return;

                try {
                    const response = await fetch(`${SERVER_URL}/api/users/remove-vip`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            telegramId: telegramId,
                            userId: this.currentUserId
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification(result.message, 'success');
                        this.loadUsersFromSupabase();
                    } else {
                        this.showNotification('Error al quitar VIP: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Error quitando VIP:', error);
                    this.showNotification('Error al quitar VIP al usuario', 'error');
                }
            }
            
            async notifyVipExpiring(telegramId) {
                this.showNotification(`Notificaci√≥n enviada al usuario ${telegramId} sobre su VIP pr√≥ximo a expirar.`, 'success');
            }
            
            setupRealtimeSubscription() {
                supabase
                    .channel('signals-channel')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'signals' 
                        }, 
                        (payload) => {
                            console.log('Nueva se√±al recibida:', payload);
                            this.handleNewSignal(payload.new);
                        }
                    )
                    .on('postgres_changes', 
                        { 
                            event: 'UPDATE', 
                            schema: 'public', 
                            table: 'signals' 
                        }, 
                        (payload) => {
                            console.log('Se√±al actualizada:', payload);
                            this.handleUpdatedSignal(payload.new);
                        }
                    )
                    .subscribe();
            }
            
            handleNewSignal(signalData) {
                const signal = {
                    id: signalData.id,
                    asset: signalData.asset,
                    timeframe: signalData.timeframe,
                    direction: signalData.direction,
                    timestamp: new Date(signalData.created_at),
                    expires: new Date(signalData.expires_at),
                    status: signalData.status || 'pending',
                    isFree: signalData.is_free || false
                };
                
                const canReceiveSignal = this.isVIP || signal.isFree;
                
                if (canReceiveSignal) {
                    this.signals.unshift(signal);
                    this.operations.unshift(signal);
                    this.renderSignals();
                    this.showNotification('Nueva se√±al recibida!', 'success');
                    
                    if (this.isReady) {
                        this.showAlert(signal);
                    }
                } else {
                    this.showNotification('Se√±al VIP enviada (solo para usuarios VIP)', 'info');
                }
                
                this.updateStats();
            }
            
            handleUpdatedSignal(signalData) {
                const signalIndex = this.signals.findIndex(s => s.id === signalData.id);
                const operationIndex = this.operations.findIndex(o => o.id === signalData.id);
                
                if (signalIndex !== -1) {
                    this.signals[signalIndex].status = signalData.status;
                }
                
                if (operationIndex !== -1) {
                    this.operations[operationIndex].status = signalData.status;
                }
                
                this.renderSignals();
                this.updateStats();
            }
            
            showVipModal() {
                this.vipModal.style.display = 'block';
                setTimeout(() => {
                    this.vipModal.classList.add('active');
                }, 10);
            }
            
            hideVipModal() {
                this.vipModal.classList.remove('active');
                setTimeout(() => {
                    this.vipModal.style.display = 'none';
                }, 300);
            }
            
            showAdminPanel() {
                this.adminPanel.style.display = this.adminPanel.style.display === 'none' ? 'block' : 'none';
            }
            
            updateUserStatus() {
                if (this.isVIP) {
                    this.userStatus.innerHTML = `
                        <div class="session-info" style="border-color: var(--vip);">
                            <i class="fas fa-crown"></i> Estado: <span class="vip-badge">USUARIO VIP</span> - Recibiendo todas las se√±ales
                        </div>
                    `;
                } else if (this.isAdmin) {
                    this.userStatus.innerHTML = `
                        <div class="session-info" style="border-color: var(--primary);">
                            <i class="fas fa-user-shield"></i> Estado: <span style="color: var(--primary); font-weight: bold;">ADMINISTRADOR</span> - Acceso completo al sistema
                        </div>
                    `;
                } else {
                    this.userStatus.innerHTML = `
                        <div class="session-info">
                            <i class="fas fa-user"></i> Estado: Usuario Regular - Solo primera se√±al gratuita por sesi√≥n
                        </div>
                    `;
                }
            }
            
            async startTradingSession() {
                try {
                    const response = await fetch(`${SERVER_URL}/api/sessions/start`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.hasReceivedFreeSignal = false;
                        
                        this.currentSession = {
                            id: Date.now(),
                            startTime: new Date(),
                            endTime: null,
                            signals: []
                        };
                        
                        this.startSession.disabled = true;
                        this.endSession.disabled = false;
                        
                        this.sessionInfo.innerHTML = `
                            <i class="fas fa-play-circle"></i> Sesi√≥n activa - Iniciada: ${this.currentSession.startTime.toLocaleTimeString()}
                        `;
                        this.sessionInfo.classList.add('session-active');
                        
                        this.showNotification('Sesi√≥n de trading iniciada', 'success');
                    } else {
                        throw new Error('Error iniciando sesi√≥n');
                    }
                } catch (error) {
                    console.error('Error iniciando sesi√≥n:', error);
                    this.showNotification('Error al iniciar sesi√≥n', 'error');
                }
            }
            
            async endTradingSession() {
                if (!this.currentSession) return;
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/sessions/end`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.currentSession.endTime = new Date();
                        this.sessions.push(this.currentSession);
                        
                        this.startSession.disabled = false;
                        this.endSession.disabled = true;
                        
                        this.sessionInfo.innerHTML = `
                            <i class="fas fa-stop-circle"></i> Sesi√≥n finalizada - Duraci√≥n: ${this.getSessionDuration(this.currentSession)}
                        `;
                        this.sessionInfo.classList.remove('session-active');
                        
                        this.currentSession = null;
                        
                        this.saveToLocalStorage();
                        this.updateStats();
                        
                        this.showNotification('Sesi√≥n de trading finalizada', 'info');
                    } else {
                        throw new Error('Error finalizando sesi√≥n');
                    }
                } catch (error) {
                    console.error('Error finalizando sesi√≥n:', error);
                    this.showNotification('Error al finalizar sesi√≥n', 'error');
                }
            }
            
            getSessionDuration(session) {
                const endTime = session.endTime || new Date();
                const duration = endTime - session.startTime;
                const minutes = Math.floor(duration / 60000);
                const seconds = ((duration % 60000) / 1000).toFixed(0);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }
            
            async sendClientNotification() {
                try {
                    const response = await fetch(`${SERVER_URL}/api/notify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.showNotification('Notificaci√≥n enviada a los clientes', 'success');
                        
                        if (this.isReady) {
                            this.showClientAlert();
                        }
                    } else {
                        throw new Error('Error enviando notificaci√≥n');
                    }
                } catch (error) {
                    console.error('Error enviando notificaci√≥n:', error);
                    this.showNotification('Error al enviar notificaci√≥n', 'error');
                }
            }
            
            showClientAlert() {
                const alert = document.createElement('div');
                alert.className = 'signal-alert';
                alert.innerHTML = `
                    <div class="asset" style="color: var(--warning);">ATENCI√ìN</div>
                    <div class="direction" style="background: rgba(255, 204, 0, 0.15); color: var(--warning); border: 1px solid var(--warning);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Sesi√≥n en 10 minutos</span>
                    </div>
                    <div class="time-remaining" style="background: rgba(255, 204, 0, 0.1); color: var(--warning);">
                        La sesi√≥n de trading comenzar√° en 10 minutos. Prep√°rate!
                    </div>
                    <button id="closeClientAlert" style="margin-top: 20px; background: var(--warning); color: var(--dark);">ENTENDIDO</button>
                `;
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    alert.classList.add('show');
                }, 100);
                
                const closeBtn = alert.querySelector('#closeClientAlert');
                closeBtn.addEventListener('click', () => {
                    alert.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(alert);
                    }, 500);
                });
            }
            
            toggleReady() {
                this.isReady = !this.isReady;
                if (this.isReady) {
                    this.readyBtn.innerHTML = '<i class="fas fa-check"></i> LISTOS';
                    this.readyBtn.classList.add('ready');
                    this.showNotification('Estado cambiado a LISTOS - Recibir√°s alertas de se√±ales', 'success');
                } else {
                    this.readyBtn.innerHTML = '<i class="fas fa-bell"></i> PREPARADOS';
                    this.readyBtn.classList.remove('ready');
                    this.showNotification('Estado cambiado a PREPARADOS', 'info');
                }
            }
            
            async sendSignal() {
                const asset = document.getElementById('asset').value;
                const timeframe = document.getElementById('timeframe').value;
                const direction = document.getElementById('direction').value;
                
                if(!asset) {
                    alert('Por favor, ingresa un activo');
                    return;
                }
                
                try {
                    const response = await fetch(`${SERVER_URL}/api/signals`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            asset: asset.toUpperCase(),
                            timeframe: parseInt(timeframe),
                            direction: direction,
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.hasReceivedFreeSignal = true;
                        document.getElementById('asset').value = '';
                        
                        this.showNotification('Se√±al enviada correctamente', 'success');
                        
                        console.log('Se√±al enviada:', result);
                    } else {
                        throw new Error('Error enviando se√±al');
                    }
                } catch (error) {
                    console.error('Error enviando se√±al:', error);
                    alert('Error al enviar la se√±al. Por favor, int√©ntalo de nuevo.');
                }
            }
            
            async updateOperationStatus(operationId, status) {
                try {
                    const response = await fetch(`${SERVER_URL}/api/signals/${operationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: status,
                            userId: this.currentUserId
                        })
                    });
                    
                    if (response.ok) {
                        this.showNotification(`Estado cambiado a: ${status}`, 'info');
                    } else {
                        throw new Error('Error actualizando estado');
                    }
                } catch (error) {
                    console.error('Error actualizando estado:', error);
                    alert('Error al actualizar el estado. Por favor, int√©ntalo de nuevo.');
                }
            }
            
            renderSignals() {
                if(this.signals.length === 0) {
                    this.signalsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-satellite-dish"></i>
                            <p>Esperando se√±ales de trading...</p>
                            <p>Las se√±ales aparecer√°n aqu√≠ autom√°ticamente</p>
                        </div>
                    `;
                    return;
                }
                
                this.signalsContainer.innerHTML = this.signals.map(signal => {
                    const expiresDate = new Date(signal.expires);
                    const timeRemaining = Math.max(0, Math.floor((expiresDate - new Date()) / 1000));
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    const isExpired = timeRemaining <= 0;
                    
                    let statusClass = 'status-pending';
                    let statusText = 'PENDIENTE';
                    let statusIcon = '<i class="fas fa-clock"></i>';
                    let resultBadge = '';
                    
                    if (signal.status === 'profit') {
                        statusClass = 'status-profit';
                        statusText = 'GANADA';
                        statusIcon = '<i class="fas fa-check-circle"></i>';
                        resultBadge = '<div class="operation-result result-profit">PROFIT</div>';
                    } else if (signal.status === 'loss') {
                        statusClass = 'status-loss';
                        statusText = 'PERDIDA';
                        statusIcon = '<i class="fas fa-times-circle"></i>';
                        resultBadge = '<div class="operation-result result-loss">LOSS</div>';
                    } else if (isExpired) {
                        statusClass = 'status-pending';
                        statusText = 'EXPIRADA';
                        statusIcon = '<i class="fas fa-hourglass-end"></i>';
                    }
                    
                    return `
                        <div class="signal-card ${isExpired ? '' : 'new'}">
                            ${resultBadge}
                            <div class="signal-header">
                                <div class="asset">${signal.asset} ${signal.isFree ? '<span class="vip-badge">GRATIS</span>' : ''}</div>
                                <div class="direction ${signal.direction}">
                                    <span class="arrow ${signal.direction}">${signal.direction === 'up' ? '‚Üë' : '‚Üì'}</span>
                                    <span>${signal.direction === 'up' ? 'ALZA' : 'BAJA'}</span>
                                </div>
                            </div>
                            <div class="signal-details">
                                <div class="detail-item">
                                    <span class="detail-label">Duraci√≥n</span>
                                    <span class="detail-value">${signal.timeframe} minuto${signal.timeframe > 1 ? 's' : ''}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Expira</span>
                                    <span class="detail-value">${expiresDate.toLocaleTimeString()}</span>
                                </div>
                            </div>
                            ${!isExpired ? `
                                <div class="time-remaining">
                                    <i class="fas fa-clock"></i> Tiempo restante: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}
                                </div>
                            ` : ''}
                            <div class="signal-status">
                                <div class="status-badge ${statusClass}">
                                    ${statusIcon} ${statusText}
                                </div>
                                ${this.isAdmin && isExpired && signal.status === 'pending' ? `
                                    <div class="admin-controls">
                                        <button class="admin-btn btn-profit" onclick="signalManager.updateOperationStatus(${signal.id}, 'profit')">
                                            <i class="fas fa-check"></i> Ganada
                                        </button>
                                        <button class="admin-btn btn-loss" onclick="signalManager.updateOperationStatus(${signal.id}, 'loss')">
                                            <i class="fas fa-times"></i> Perdida
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                setTimeout(() => {
                    const newCards = document.querySelectorAll('.signal-card.new');
                    newCards.forEach(card => {
                        card.classList.remove('new');
                    });
                }, 1500);
            }
            
            showNotification(message, type = 'info') {
                this.notification.textContent = message;
                
                if (type === 'success') {
                    this.notification.style.background = 'var(--profit)';
                } else if (type === 'error') {
                    this.notification.style.background = 'var(--loss)';
                } else if (type === 'vip') {
                    this.notification.style.background = 'var(--vip)';
                } else {
                    this.notification.style.background = 'var(--primary)';
                }
                
                this.notification.classList.add('show');
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 3000);
            }
            
            showAlert(signal) {
                document.getElementById('alertAsset').textContent = signal.asset;
                
                const alertDirection = document.getElementById('alertDirection');
                alertDirection.className = `direction ${signal.direction}`;
                alertDirection.innerHTML = `
                    <span class="arrow ${signal.direction}">${signal.direction === 'up' ? '‚Üë' : '‚Üì'}</span>
                    <span>${signal.direction === 'up' ? 'ALZA (CALL)' : 'BAJA (PUT)'}</span>
                `;
                
                const expiresDate = new Date(signal.expires);
                const timeRemaining = Math.max(0, Math.floor((expiresDate - new Date()) / 1000));
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('alertTime').textContent = `Expira en: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                this.signalAlert.classList.add('show');
            }
            
            hideAlert() {
                this.signalAlert.classList.remove('show');
            }
            
            showSignalsView() {
                this.statsContainer.classList.remove('active');
                this.usersContainer.classList.remove('active');
                this.showSignals.classList.add('active');
                this.showStats.classList.remove('active');
                this.showUsers.classList.remove('active');
                document.getElementById('signalsPanel').classList.add('active');
                document.getElementById('statsContainer').classList.remove('active');
                document.getElementById('usersContainer').classList.remove('active');
            }
            
            showStatsView() {
                this.statsContainer.classList.add('active');
                this.usersContainer.classList.remove('active');
                this.showSignals.classList.remove('active');
                this.showStats.classList.add('active');
                this.showUsers.classList.remove('active');
                document.getElementById('signalsPanel').classList.remove('active');
                document.getElementById('statsContainer').classList.add('active');
                document.getElementById('usersContainer').classList.remove('active');
                this.updateStats();
            }
            
            showUsersView() {
                this.statsContainer.classList.remove('active');
                this.usersContainer.classList.add('active');
                this.showSignals.classList.remove('active');
                this.showStats.classList.remove('active');
                this.showUsers.classList.add('active');
                document.getElementById('signalsPanel').classList.remove('active');
                document.getElementById('statsContainer').classList.remove('active');
                document.getElementById('usersContainer').classList.add('active');
            }
            
            updateStats(period = 'day') {
                const now = new Date();
                let filteredOperations = [];
                
                if (period === 'day') {
                    filteredOperations = this.operations.filter(op => {
                        const opDate = new Date(op.timestamp);
                        return opDate.toDateString() === now.toDateString();
                    });
                } else if (period === 'week') {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    filteredOperations = this.operations.filter(op => {
                        const opDate = new Date(op.timestamp);
                        return opDate >= startOfWeek;
                    });
                } else if (period === 'month') {
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    filteredOperations = this.operations.filter(op => {
                        const opDate = new Date(op.timestamp);
                        return opDate >= startOfMonth;
                    });
                }
                
                const winOperations = filteredOperations.filter(op => op.status === 'profit');
                const lossOperations = filteredOperations.filter(op => op.status === 'loss');
                const totalOperations = filteredOperations.length;
                
                const winCount = winOperations.length;
                const lossCount = lossOperations.length;
                
                this.winCount.textContent = winCount;
                this.lossCount.textContent = lossCount;
                this.totalCount.textContent = totalOperations;
                
                this.operationsTable.innerHTML = filteredOperations.map(op => {
                    let statusClass = 'status-pending';
                    let statusText = 'PENDIENTE';
                    let statusIcon = '<i class="fas fa-clock"></i>';
                    
                    if (op.status === 'profit') {
                        statusClass = 'status-profit';
                        statusText = 'GANADA';
                        statusIcon = '<i class="fas fa-check-circle"></i>';
                    } else if (op.status === 'loss') {
                        statusClass = 'status-loss';
                        statusText = 'PERDIDA';
                        statusIcon = '<i class="fas fa-times-circle"></i>';
                    }
                    
                    return `
                        <tr>
                            <td>${op.asset}</td>
                            <td>
                                <span class="direction ${op.direction}">
                                    ${op.direction === 'up' ? 'ALZA' : 'BAJA'}
                                </span>
                            </td>
                            <td>${op.timeframe} min</td>
                            <td><span class="status-badge ${statusClass}">${statusIcon} ${statusText}</span></td>
                            <td>${new Date(op.timestamp).toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
                
                this.updateChart(winCount, lossCount, totalOperations);
            }
            
            initChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                this.performanceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ganadas', 'Perdidas', 'Pendientes'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(0, 255, 157, 0.8)',
                                'rgba(255, 0, 51, 0.8)',
                                'rgba(255, 204, 0, 0.8)'
                            ],
                            borderColor: [
                                'rgba(0, 255, 157, 1)',
                                'rgba(255, 0, 51, 1)',
                                'rgba(255, 204, 0, 1)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'white',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Distribuci√≥n de Operaciones',
                                color: 'white',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }
            
            updateChart(winCount, lossCount, totalCount) {
                const pendingCount = totalCount - winCount - lossCount;
                
                this.performanceChart.data.datasets[0].data = [winCount, lossCount, pendingCount];
                this.performanceChart.update();
            }
            
            saveToLocalStorage() {
                const data = {
                    sessions: this.sessions,
                    currentSession: this.currentSession,
                    isVIP: this.isVIP,
                    hasReceivedFreeSignal: this.hasReceivedFreeSignal
                };
                localStorage.setItem('quantumTraderData', JSON.stringify(data));
            }
            
            loadFromLocalStorage() {
                const data = JSON.parse(localStorage.getItem('quantumTraderData'));
                if (data) {
                    this.sessions = data.sessions || [];
                    this.currentSession = data.currentSession || null;
                    this.isVIP = data.isVIP !== undefined ? data.isVIP : false;
                    this.hasReceivedFreeSignal = data.hasReceivedFreeSignal || false;
                    
                    if (this.currentSession) {
                        this.currentSession.startTime = new Date(this.currentSession.startTime);
                        if (this.currentSession.endTime) {
                            this.currentSession.endTime = new Date(this.currentSession.endTime);
                        }
                    }
                    
                    if (this.currentSession) {
                        this.startSession.disabled = true;
                        this.endSession.disabled = false;
                        this.sessionInfo.innerHTML = `
                            <i class="fas fa-play-circle"></i> Sesi√≥n activa - Iniciada: ${this.currentSession.startTime.toLocaleTimeString()}
                        `;
                        this.sessionInfo.classList.add('session-active');
                    }
                    
                    this.updateUserStatus();
                }
            }
        }

        // =============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // =============================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ [APP] DOM cargado - Iniciando aplicaci√≥n');
            createParticles();
            
            // Inicializar SignalManager con el User ID ya detectado
            signalManager = new SignalManager();
            
            setInterval(() => {
                if (signalManager) {
                    signalManager.renderSignals();
                    
                    const alert = document.getElementById('signalAlert');
                    if (alert.classList.contains('show')) {
                        const activeSignal = signalManager.signals[0];
                        if (activeSignal) {
                            const expiresDate = new Date(activeSignal.expires);
                            const timeRemaining = Math.max(0, Math.floor((expiresDate - new Date()) / 1000));
                            const minutes = Math.floor(timeRemaining / 60);
                            const seconds = timeRemaining % 60;
                            document.getElementById('alertTime').textContent = `Expira en: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        }
                    }
                }
            }, 1000);
        });

        // =============================================
        // VERIFICACI√ìN INMEDIATA DE ADMIN
        // =============================================

        console.log('=== üîç VERIFICACI√ìN DE ADMIN INICIADA ===');
        console.log('User ID detectado:', detectedUserId);
        console.log('ADMIN_ID configurado:', ADMIN_ID);
        console.log('¬øCoinciden?:', String(detectedUserId).trim() === String(ADMIN_ID).trim());

        // Verificaci√≥n adicional despu√©s de 3 segundos
        setTimeout(async () => {
            console.log('=== üîç VERIFICACI√ìN TARD√çA DE ADMIN ===');
            if (signalManager) {
                console.log('Estado actual en SignalManager:');
                console.log('- isAdmin:', signalManager.isAdmin);
                console.log('- isVIP:', signalManager.isVIP);
                console.log('- User ID:', signalManager.currentUserId);
                
                // Forzar recarga de datos
                await signalManager.loadUserData();
            }
        }, 3000);
    </script>
</body>
</html>
